<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>cmdline.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">cmdline.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="cmdline.c">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * Copyright (c) 1999 Apple Computer, Inc. All rights reserved.
 *
 * @APPLE_LICENSE_HEADER_START@
 * 
 * &quot;Portions Copyright (c) 1999 Apple Computer, Inc.  All Rights
 * Reserved.  This file contains Original Code and/or Modifications of
 * Original Code as defined in and that are subject to the Apple Public
 * Source License Version 1.0 (the 'License').  You may not use this file
 * except in compliance with the License.  Please obtain a copy of the
 * License at <a href="http://www.apple.com/publicsource">http://www.apple.com/publicsource</a> and read it before using
 * this file.
 * 
 * The Original Code and all software distributed under the License are
 * distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
 * EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
 * INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE OR NON-INFRINGEMENT.  Please see the
 * License for the specific language governing rights and limitations
 * under the License.&quot;
 * 
 * @APPLE_LICENSE_HEADER_END@
 */</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdio.h&gt;</span>
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">__linux__</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdlib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;unistd.h&gt;</span>
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;errno.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;fcntl.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;io.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;errors.h&quot;</span>

#<span class="enscript-reference">import</span> <span class="enscript-string">&quot;pdisk.h&quot;</span>
#<span class="enscript-reference">import</span> <span class="enscript-string">&quot;partition_map.h&quot;</span>
#<span class="enscript-reference">import</span> <span class="enscript-string">&quot;dump.h&quot;</span>

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CMD_FAIL</span>	1
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CMD_SUCCESS</span>	0

#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MIN_PARTITION_SIZE</span> 4

<span class="enscript-type">typedef</span> <span class="enscript-function-name">int</span> (*funcPtr_t)();

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> {
    <span class="enscript-type">char</span> *		name;
    funcPtr_t		func;
    <span class="enscript-type">int</span>			nargs;
    <span class="enscript-type">char</span> *		description;
} cmdline_option_t;


<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">block_size</span>();
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">create_partition</span>();
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">delete_partition</span>();
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">disk_is_partitioned</span>();
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">initialize</span>();
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">our_dump</span>();
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">partition_display</span>();
<span class="enscript-type">static</span> <span class="enscript-type">int</span> <span class="enscript-function-name">split_partition</span>();

cmdline_option_t optionTable[] = {
    { <span class="enscript-string">&quot;-blockSize&quot;</span>, block_size, 0, <span class="enscript-string">&quot;display the block size used by the map&quot;</span> },
    { <span class="enscript-string">&quot;-createPartition&quot;</span>, create_partition, 0, <span class="enscript-string">&quot;create a new partition&quot;</span> },
    { <span class="enscript-string">&quot;-deletePartition&quot;</span>, delete_partition, 0, <span class="enscript-string">&quot;delete a partition&quot;</span> },
    { <span class="enscript-string">&quot;-dump&quot;</span>, our_dump, 0, <span class="enscript-string">&quot;dump the list of partitions&quot;</span> },
    { <span class="enscript-string">&quot;-initialize&quot;</span>, initialize, 0, <span class="enscript-string">&quot;initialize the partition map&quot;</span> },
    { <span class="enscript-string">&quot;-isDiskPartitioned&quot;</span>, disk_is_partitioned, 0, <span class="enscript-string">&quot;is the disk partitioned&quot;</span> },
    { <span class="enscript-string">&quot;-partitionEntry&quot;</span>, partition_display, 0, <span class="enscript-string">&quot;get the partition name, type, base, and size&quot;</span> },
    { <span class="enscript-string">&quot;-splitPartition&quot;</span>, split_partition, 0, <span class="enscript-string">&quot;split an existing partition in two pieces&quot;</span> },
    { 0, 0, 0 },
};

<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">initialize</span>(<span class="enscript-type">char</span> * name)
{
    partition_map_header * map;

    map = create_partition_map(name, NULL, O_RDWR);
    <span class="enscript-keyword">if</span> (map == NULL)
	<span class="enscript-keyword">return</span> (CMD_FAIL);
    add_partition_to_map(<span class="enscript-string">&quot;Apple&quot;</span>, kMapType,
			 1, (map-&gt;media_size &lt;= 128? 2: 63), map);
    write_partition_map(map);
    close_partition_map(map);
    <span class="enscript-keyword">return</span> (CMD_SUCCESS);
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">block_size</span>(<span class="enscript-type">char</span> * name)
{
    partition_map_header *map;
    <span class="enscript-type">int</span> junk;

    map = open_partition_map(name, &amp;junk, 0, O_RDONLY);
    <span class="enscript-keyword">if</span> (map == NULL) {
	<span class="enscript-keyword">return</span> (CMD_FAIL);
    }
    printf(<span class="enscript-string">&quot;%d\n&quot;</span>, map-&gt;logical_block);
    close_partition_map(map);
    <span class="enscript-keyword">return</span> (CMD_SUCCESS);
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">our_dump</span>(<span class="enscript-type">char</span> * name)
{
    partition_map_header *map;
    <span class="enscript-type">int</span> junk;

    map = open_partition_map(name, &amp;junk, 0, O_RDONLY);
    <span class="enscript-keyword">if</span> (map == NULL) {
	<span class="enscript-keyword">return</span> (CMD_FAIL);
    }

    dump_partition_map(map, 1);

    close_partition_map(map);
    <span class="enscript-keyword">return</span> (CMD_SUCCESS);
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">disk_is_partitioned</span>(<span class="enscript-type">char</span> * name)
{
    partition_map_header *map;
    <span class="enscript-type">int</span> junk;

    map = open_partition_map(name, &amp;junk, 0, O_RDONLY);
    <span class="enscript-keyword">if</span> (map) {
	close_partition_map(map);
	<span class="enscript-keyword">return</span> (CMD_SUCCESS);
    }
    <span class="enscript-keyword">return</span> (CMD_FAIL);
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">partition_display</span>(<span class="enscript-type">char</span> * name, <span class="enscript-type">int</span> argc, <span class="enscript-type">char</span> * * argv)
{
    partition_map * 		entry;
    <span class="enscript-type">int</span>				junk;
    <span class="enscript-type">int</span>				j;
    partition_map_header * 	map;
    <span class="enscript-type">int</span>				rv = CMD_FAIL;

    <span class="enscript-keyword">if</span> (argc &lt; 2) {
	fprintf(stderr, <span class="enscript-string">&quot;pdisk: %s &lt;partition number&gt;\n&quot;</span>, *argv);
	<span class="enscript-keyword">return</span> (CMD_FAIL);
    }

    map = open_partition_map(name, &amp;junk, 0, O_RDONLY);
    <span class="enscript-keyword">if</span> (!map) {
	fprintf(stderr, <span class="enscript-string">&quot;pdisk: disk is not partitioned\n&quot;</span>);
	<span class="enscript-keyword">return</span> (CMD_FAIL);
    }
    j = atoi(argv[1]);
    entry = find_entry_by_disk_address(j, map);
    <span class="enscript-keyword">if</span> (!entry) {
	fprintf(stderr, <span class="enscript-string">&quot;pdisk: partition %d does not exist\n&quot;</span>, j);
    }
    <span class="enscript-keyword">else</span> {
	DPME * p = entry-&gt;data;

	rv = CMD_SUCCESS;

	printf(<span class="enscript-string">&quot;%s %s %u %u\n&quot;</span>, p-&gt;dpme_name, p-&gt;dpme_type, 
	    p-&gt;dpme_pblock_start, p-&gt;dpme_pblocks);
    }
    close_partition_map(map);
    <span class="enscript-keyword">return</span> (rv);
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">split_partition</span>(<span class="enscript-type">char</span> * name, <span class="enscript-type">int</span> argc, <span class="enscript-type">char</span> * * argv)
{
    partition_map * 		entry;
    <span class="enscript-type">int</span>				junk;
    partition_map_header * 	map;
    u32 			new_size;
    <span class="enscript-type">int</span>				part;
    <span class="enscript-type">int</span>				rv = CMD_SUCCESS;
    <span class="enscript-type">char</span> *			split_name;
    <span class="enscript-type">char</span> *			split_type;

    <span class="enscript-keyword">if</span> (argc &lt; 5) {
	fprintf(stderr, <span class="enscript-string">&quot;pdisk %s &lt;partno&gt; &lt;1st part size&gt; &lt;2nd part name&gt; &lt;2nd part type&gt;\n&quot;</span>,
	       argv[0]);
	<span class="enscript-keyword">return</span> (CMD_FAIL);
    }
    map = open_partition_map(name, &amp;junk, 0, O_RDWR);
    <span class="enscript-keyword">if</span> (!map) {
	fprintf(stderr, <span class="enscript-string">&quot;pdisk: no valid partitions exist\n&quot;</span>);
	<span class="enscript-keyword">return</span> (CMD_FAIL);
    }
    part = atoi(argv[1]);
    new_size = strtoul(argv[2], NULL, 10);
    split_name = argv[3];
    split_type = argv[4];
    entry = find_entry_by_disk_address(part, map);
    rv = CMD_FAIL;
    <span class="enscript-keyword">if</span> (!entry) {
	fprintf(stderr, <span class="enscript-string">&quot;pdisk: partition %d does not exist\n&quot;</span>, part);
    }
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (strcmp(entry-&gt;data-&gt;dpme_type, kFreeType) == 0
	     || strcmp(entry-&gt;data-&gt;dpme_type, kMapType) == 0) {
	fprintf(stderr, <span class="enscript-string">&quot;pdisk: cannot split partition %d because its type is %s\n&quot;</span>,
	       part, entry-&gt;data-&gt;dpme_type);
    }
    <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!((new_size &gt; 0)
	       &amp;&amp; (new_size 
		   &lt;= (entry-&gt;data-&gt;dpme_pblocks - MIN_PARTITION_SIZE))
	       &amp;&amp; (new_size &gt;= MIN_PARTITION_SIZE))) {
	fprintf(stderr, <span class="enscript-string">&quot;pdisk: split size of&quot;</span>
	       <span class="enscript-string">&quot; partition %d must be between %u and %u\n&quot;</span>,
	       part, (u32)MIN_PARTITION_SIZE, 
	       (entry-&gt;data-&gt;dpme_pblocks - (u32)MIN_PARTITION_SIZE));
    }
    <span class="enscript-keyword">else</span> {
	DPME save_dpme;

	save_dpme = *entry-&gt;data;
	delete_partition_from_map(entry);
	add_partition_to_map(save_dpme.dpme_name, save_dpme.dpme_type,
			     save_dpme.dpme_pblock_start, new_size, map);
	add_partition_to_map(split_name, split_type, 
			     save_dpme.dpme_pblock_start + new_size,
			     save_dpme.dpme_pblocks - new_size, map);
	write_partition_map(map);

        entry = find_entry_by_base(save_dpme.dpme_pblock_start + new_size, map);
        <span class="enscript-keyword">if</span> (entry) {
            printf(<span class="enscript-string">&quot;%lu\n&quot;</span>, entry-&gt;disk_address);
        }
	rv = CMD_SUCCESS;
    }

    close_partition_map(map);
    <span class="enscript-keyword">return</span> (rv);
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">create_partition</span>(<span class="enscript-type">char</span> * name, <span class="enscript-type">int</span> argc, <span class="enscript-type">char</span> * * argv)
{
    partition_map * 		entry;
    <span class="enscript-type">int</span>				junk;
    partition_map_header * 	map;
    <span class="enscript-type">int</span>				rv = CMD_SUCCESS;
    u32				part_base;
    <span class="enscript-type">char</span> *			part_name;
    u32 			part_size;
    <span class="enscript-type">char</span> *			part_type;

    <span class="enscript-keyword">if</span> (argc &lt; 5) {
	fprintf(stderr, <span class="enscript-string">&quot;%s &lt;name&gt; &lt;type&gt; &lt;base&gt; &lt;size&gt;\n&quot;</span>,
	       argv[0]);
	<span class="enscript-keyword">return</span> (CMD_FAIL);
    }
    map = open_partition_map(name, &amp;junk, 0, O_RDWR);
    <span class="enscript-keyword">if</span> (!map) {
	fprintf(stderr, <span class="enscript-string">&quot;pdisk: disk is not partitioned\n&quot;</span>);
	<span class="enscript-keyword">return</span> (CMD_FAIL);
    }
    part_name = argv[1];
    part_type = argv[2];
    part_base = strtoul(argv[3], NULL, 10);
    part_size = strtoul(argv[4], NULL, 10);
    rv = CMD_FAIL;
    <span class="enscript-keyword">if</span> (add_partition_to_map(part_name, part_type, part_base, part_size, map) 
	== 1) {
	write_partition_map(map);
	entry = find_entry_by_base(part_base, map);
	<span class="enscript-keyword">if</span> (entry) {
	    printf(<span class="enscript-string">&quot;%lu\n&quot;</span>, entry-&gt;disk_address);
	    rv = CMD_SUCCESS;
	}
    }
    close_partition_map(map);
    <span class="enscript-keyword">return</span> (rv);
}

<span class="enscript-type">static</span> <span class="enscript-type">int</span>
<span class="enscript-function-name">delete_partition</span>(<span class="enscript-type">char</span> * name, <span class="enscript-type">int</span> argc, <span class="enscript-type">char</span> * * argv)
{
    partition_map * 		cur;
    <span class="enscript-type">int</span>				junk;
    partition_map_header * 	map;
    <span class="enscript-type">int</span>				rv = CMD_SUCCESS;
    u32				part_num;

    <span class="enscript-keyword">if</span> (argc &lt; 2) {
        fprintf(stderr, <span class="enscript-string">&quot;%s &lt;part&gt;\n&quot;</span>,
               argv[0]);
        <span class="enscript-keyword">return</span> (CMD_FAIL);
    }
    map = open_partition_map(name, &amp;junk, 0, O_RDWR);
    <span class="enscript-keyword">if</span> (!map) {
        fprintf(stderr, <span class="enscript-string">&quot;pdisk: disk is not partitioned\n&quot;</span>);
        <span class="enscript-keyword">return</span> (CMD_FAIL);
    }
    part_num = atoi(argv[1]);
    rv = CMD_FAIL;

    cur = find_entry_by_disk_address(part_num, map);
    <span class="enscript-keyword">if</span> (cur == NULL) {
        fprintf(stderr, <span class="enscript-string">&quot;No such partition\n&quot;</span>);
    } <span class="enscript-keyword">else</span> {
        delete_partition_from_map(cur);
    }
    write_partition_map(map);
    rv = CMD_SUCCESS;   
    
    close_partition_map(map);
    <span class="enscript-keyword">return</span> (rv);
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">do_command_help</span>()
{
    cmdline_option_t * tbl_p;

    fprintf(stderr, <span class="enscript-string">&quot;command:\n&quot;</span>);
    <span class="enscript-keyword">for</span> (tbl_p = optionTable; tbl_p-&gt;name; tbl_p++) {
	fprintf(stderr, <span class="enscript-string">&quot;\t%-20s %s\n&quot;</span>, tbl_p-&gt;name, tbl_p-&gt;description);
    }
}

<span class="enscript-type">int</span>
<span class="enscript-function-name">do_command_line</span>(<span class="enscript-type">int</span> argc, <span class="enscript-type">char</span> * argv[])
{
    <span class="enscript-type">char</span> * 		devName = *argv;
    cmdline_option_t * 	options_p;

    argv++;
    argc--;
    <span class="enscript-keyword">if</span> (!argc) {
        <span class="enscript-keyword">return</span> (CMD_FAIL);
    }
    <span class="enscript-keyword">for</span> (options_p = &amp;optionTable[0]; options_p-&gt;func; options_p++) {
        <span class="enscript-keyword">if</span> (strcmp(options_p-&gt;name, *argv) == 0) {
               exit ((options_p-&gt;func)(devName, argc, argv));
        }
    }
    <span class="enscript-keyword">return</span> (CMD_FAIL);
}

</pre>
<hr />
</body></html>