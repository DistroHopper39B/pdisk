<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>cvt_pt.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">cvt_pt.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="cvt_pt.c">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * cvt_pt.c
 *
 *	Convert partition type.
 *
 *	Copyright (c)  1999, Eryk Vershen
 * 
 * History:
 * Log: cvt_pt.c,v
 * Revision 1.2  2000/05/16 13:56:11  eryk
 * Minor fixes
 *
 * Revision 1.1  2000/02/13 22:04:08  eryk
 * Initial revision
 *
 */</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdio.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdlib.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdarg.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;errno.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;ctype.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;partition_map.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;errors.h&quot;</span>


<span class="enscript-comment">/*
 * Defines / Constants
 */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CFLAG_DEFAULT</span>	0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DFLAG_DEFAULT</span>	0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">HFLAG_DEFAULT</span>	0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">INTERACT_DEFAULT</span>	0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">RFLAG_DEFAULT</span>	0


<span class="enscript-comment">/*
 * Structs / Types
 */</span>


<span class="enscript-comment">/*
 * Global variables
 */</span>
<span class="enscript-type">int</span> hflag = HFLAG_DEFAULT;	<span class="enscript-comment">/* show help */</span>
<span class="enscript-type">int</span> dflag = DFLAG_DEFAULT;	<span class="enscript-comment">/* turn on debugging commands and printout */</span>
<span class="enscript-type">int</span> rflag = RFLAG_DEFAULT;	<span class="enscript-comment">/* open device read Only */</span>
<span class="enscript-type">int</span> interactive = INTERACT_DEFAULT;
<span class="enscript-type">int</span> cflag = CFLAG_DEFAULT;	<span class="enscript-comment">/* compute device size */</span>


<span class="enscript-comment">/*
 * Forward declarations
 */</span>
<span class="enscript-type">void</span> <span class="enscript-function-name">process</span>(<span class="enscript-type">char</span> *filename);


<span class="enscript-comment">/*
 * Start here ...
 */</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">main</span>(<span class="enscript-type">int</span> argc, <span class="enscript-type">char</span> **argv)
{
    <span class="enscript-type">register</span> <span class="enscript-type">int</span> i;
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">notdef</span>
    <span class="enscript-type">register</span> <span class="enscript-type">int</span> c;
    <span class="enscript-type">extern</span> <span class="enscript-type">char</span> *optarg;	<span class="enscript-comment">/* pointer to argument */</span>
    <span class="enscript-type">extern</span> <span class="enscript-type">int</span> optind;		<span class="enscript-comment">/* next argv index */</span>
    <span class="enscript-type">extern</span> <span class="enscript-type">int</span> opterr;		<span class="enscript-comment">/* who does error messages */</span>
    <span class="enscript-type">extern</span> <span class="enscript-type">int</span> optopt;		<span class="enscript-comment">/* char that caused the error */</span>
    <span class="enscript-type">int</span> getopt_error;		<span class="enscript-comment">/* getopt choked */</span>
    <span class="enscript-type">char</span> option_error[100];	<span class="enscript-comment">/* buffer for error message */</span>
    <span class="enscript-type">char</span> *arg_option = 0;
    <span class="enscript-type">int</span> bool_option = 0;
#<span class="enscript-reference">else</span>
    <span class="enscript-type">int</span> optind = 1;
#<span class="enscript-reference">endif</span>

    init_program_name(argv);

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">notdef</span>
    opterr = 0;	<span class="enscript-comment">/* tell getopt to be quiet */</span>

    <span class="enscript-comment">/*
     * Changes to getopt's last argument should
     * be reflected in the string printed by the
     * usage() function.
     */</span>
    <span class="enscript-keyword">while</span> ((c = getopt(argc, argv, <span class="enscript-string">&quot;a:b&quot;</span>)) != EOF) {
	<span class="enscript-keyword">if</span> (c == <span class="enscript-string">'?'</span>) {
	    getopt_error = 1;
	    c = optopt;
	} <span class="enscript-keyword">else</span> {
	    getopt_error = 0;
	}

	<span class="enscript-keyword">switch</span> (c) {
	<span class="enscript-keyword">case</span> <span class="enscript-string">'a'</span>:
	    <span class="enscript-keyword">if</span> (getopt_error) {
		usage(<span class="enscript-string">&quot;missing argument&quot;</span>);
	    } <span class="enscript-keyword">else</span> {
		arg_option = optarg;
	    }
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'b'</span>:
	    bool_option = 1;
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-reference">default</span>:
	    snprintf(option_error, <span class="enscript-keyword">sizeof</span>(option_error),
	        <span class="enscript-string">&quot;no such option as -%c&quot;</span>, c);
	    usage(option_error);
	}
    }
#<span class="enscript-reference">endif</span>

    <span class="enscript-keyword">if</span> (optind &gt;= argc) {
	usage(<span class="enscript-string">&quot;no file argument&quot;</span>);
    }
    <span class="enscript-keyword">for</span> (i = optind ; i &lt; argc; i++) {
	process(argv[i]);
    }
    <span class="enscript-keyword">return</span> 0;
}


<span class="enscript-type">int</span>
<span class="enscript-function-name">trim_num</span>(<span class="enscript-type">char</span> *s)
{
    <span class="enscript-type">char</span> *t;
    <span class="enscript-type">int</span> n;

    <span class="enscript-keyword">for</span> (t = s; *t; t++) {
    }

    <span class="enscript-keyword">for</span> (t--; t &gt;= s; t--) {
        <span class="enscript-keyword">if</span> (!isdigit((<span class="enscript-type">unsigned</span> <span class="enscript-type">char</span>)*t)) {
            t++;
            <span class="enscript-keyword">if</span> (*t) {
                n = atoi(t);
                *t = 0;
            } <span class="enscript-keyword">else</span> {
                n = -1;
            }
            <span class="enscript-keyword">return</span> n;
        }
    }

    <span class="enscript-keyword">return</span> -1;
}

<span class="enscript-comment">/*
 * The operation to apply to each file ...
 */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">process</span>(<span class="enscript-type">char</span> *filename)
{
    <span class="enscript-type">char</span> *s;
    <span class="enscript-type">int</span> index;
    partition_map_header *map;
    <span class="enscript-type">int</span> valid_file;
    partition_map * entry;

    <span class="enscript-comment">//printf(&quot;Processing %s\n&quot;, filename);
</span>
    <span class="enscript-comment">// 1)       strip off number from end of filename
</span>    s = strdup(filename);
    index = trim_num(s);

    <span class="enscript-keyword">if</span> (index &lt; 0) {
        fatal(-1, <span class="enscript-string">&quot;%s does not end in a number&quot;</span>, filename);
    }

    <span class="enscript-comment">// 2)       open prefix of filename as partition map
</span>    map = open_partition_map(s, &amp;valid_file, 0);
    <span class="enscript-keyword">if</span> (!valid_file) {
        fatal(-1, <span class="enscript-string">&quot;%s does not have a partition map&quot;</span>, s);
        <span class="enscript-keyword">return</span>;
    }

    <span class="enscript-comment">// 3)       verify the type for the partition;
</span>
    <span class="enscript-keyword">if</span> (map-&gt;writable == 0) {
	fatal(-1, <span class="enscript-string">&quot;The map is not writable&quot;</span>);
        <span class="enscript-keyword">return</span>;
    }

    <span class="enscript-comment">// 4) find partition and change it
</span>    entry = find_entry_by_disk_address(index, map);
    <span class="enscript-keyword">if</span> (entry == NULL) {
	fatal(-1, <span class="enscript-string">&quot;No such partition&quot;</span>);
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (strcmp(entry-&gt;data-&gt;dpme_type, kHFSType) != 0) {
	fatal(-1, <span class="enscript-string">&quot;Can't convert a partition with type %s&quot;</span>,
		entry-&gt;data-&gt;dpme_type);
    } <span class="enscript-keyword">else</span> {
	<span class="enscript-comment">// 4a)       modify the type
</span>	strncpy(entry-&gt;data-&gt;dpme_type, kUnixType, DPISTRLEN);
	
	<span class="enscript-comment">// 5)       and write back.
</span>	write_partition_map(map);
    }
}
</pre>
<hr />
</body></html>