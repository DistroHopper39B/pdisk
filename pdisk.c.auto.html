<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>pdisk.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">pdisk.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="pdisk.c">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">//
</span><span class="enscript-comment">// pdisk - an editor for Apple format partition tables
</span><span class="enscript-comment">//
</span><span class="enscript-comment">// Written by Eryk Vershen
</span><span class="enscript-comment">//
</span><span class="enscript-comment">// Still under development (as of 15 January 1998)
</span><span class="enscript-comment">//
</span>
<span class="enscript-comment">/*
 * Copyright 1996,1997,1998 by Apple Computer, Inc.
 *              All Rights Reserved 
 *  
 * Permission to use, copy, modify, and distribute this software and 
 * its documentation for any purpose and without fee is hereby granted, 
 * provided that the above copyright notice appears in all copies and 
 * that both the copyright notice and this permission notice appear in 
 * supporting documentation. 
 *  
 * APPLE COMPUTER DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE 
 * INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS 
 * FOR A PARTICULAR PURPOSE. 
 *  
 * IN NO EVENT SHALL APPLE COMPUTER BE LIABLE FOR ANY SPECIAL, INDIRECT, OR 
 * CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM 
 * LOSS OF USE, DATA OR PROFITS, WHETHER IN ACTION OF CONTRACT, 
 * NEGLIGENCE, OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION 
 * WITH THE USE OR PERFORMANCE OF THIS SOFTWARE. 
 */</span>

<span class="enscript-comment">// for printf()
</span>#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdio.h&gt;</span>

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__linux__</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__unix__</span>)
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;getopt.h&gt;</span>
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">__linux__</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;malloc.h&gt;</span>
#<span class="enscript-reference">else</span>
<span class="enscript-comment">// for malloc() &amp; free()
</span>#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdlib.h&gt;</span>
#<span class="enscript-reference">if</span> !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__unix__</span>)
<span class="enscript-comment">// for SIOUXsettings
</span>#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;SIOUX.h&gt;</span>
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">__unix__</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;unistd.h&gt;</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">// for strncpy() &amp; strlen()
</span>#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>
<span class="enscript-comment">// for O_RDONLY
</span>#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;fcntl.h&gt;</span>
<span class="enscript-comment">// for errno
</span>#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;errno.h&gt;</span>

#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">__linux__</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;sys/ioctl.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;linux/fs.h&gt;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;linux/hdreg.h&gt;</span>
#<span class="enscript-reference">endif</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;pdisk.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;io.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;partition_map.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;pathname.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;hfs_misc.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;errors.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;dump.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;validate.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;version.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;util.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;cmdline.h&quot;</span>


<span class="enscript-comment">//
</span><span class="enscript-comment">// Defines
</span><span class="enscript-comment">//
</span>#<span class="enscript-reference">define</span> <span class="enscript-variable-name">ARGV_CHUNK</span> 5
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">CFLAG_DEFAULT</span>	0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">DFLAG_DEFAULT</span>	0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">HFLAG_DEFAULT</span>	0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">INTERACT_DEFAULT</span>	0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">LFLAG_DEFAULT</span>	0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">RFLAG_DEFAULT</span>	0
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">VFLAG_DEFAULT</span>	0


<span class="enscript-comment">//
</span><span class="enscript-comment">// Types
</span><span class="enscript-comment">//
</span>

<span class="enscript-comment">//
</span><span class="enscript-comment">// Global Constants
</span><span class="enscript-comment">//
</span><span class="enscript-type">enum</span> getopt_values {
    kLongOption = 0,
    kBadOption = <span class="enscript-string">'?'</span>,
    kOptionArg = 1000,
    kListOption = 1001,
    kLogicalOption = 1002
};


<span class="enscript-comment">//
</span><span class="enscript-comment">// Global Variables
</span><span class="enscript-comment">//
</span><span class="enscript-type">int</span> lflag = LFLAG_DEFAULT;	<span class="enscript-comment">/* list the device */</span>
<span class="enscript-type">char</span> *lfile;	<span class="enscript-comment">/* list */</span>
<span class="enscript-type">int</span> vflag = VFLAG_DEFAULT;	<span class="enscript-comment">/* show version */</span>
<span class="enscript-type">int</span> hflag = HFLAG_DEFAULT;	<span class="enscript-comment">/* show help */</span>
<span class="enscript-type">int</span> dflag = DFLAG_DEFAULT;	<span class="enscript-comment">/* turn on debugging commands and printout */</span>
<span class="enscript-type">int</span> rflag = RFLAG_DEFAULT;	<span class="enscript-comment">/* open device read Only */</span>
<span class="enscript-type">int</span> interactive = INTERACT_DEFAULT;
<span class="enscript-type">int</span> cflag = CFLAG_DEFAULT;	<span class="enscript-comment">/* compute device size */</span>

<span class="enscript-type">static</span> <span class="enscript-type">int</span> first_get = 1;


<span class="enscript-comment">//
</span><span class="enscript-comment">// Forward declarations
</span><span class="enscript-comment">//
</span><span class="enscript-type">void</span> <span class="enscript-function-name">do_change_map_size</span>(partition_map_header *map);
<span class="enscript-type">void</span> <span class="enscript-function-name">do_update_dpme</span>(partition_map *entry);
<span class="enscript-type">void</span> <span class="enscript-function-name">do_create_partition</span>(partition_map_header *map, <span class="enscript-type">int</span> get_type);
<span class="enscript-type">void</span> <span class="enscript-function-name">do_delete_partition</span>(partition_map_header *map);
<span class="enscript-type">void</span> <span class="enscript-function-name">do_display_block</span>(partition_map_header *map, <span class="enscript-type">char</span> *alt_name);
<span class="enscript-type">void</span> <span class="enscript-function-name">do_display_entry</span>(partition_map_header *map);
<span class="enscript-type">void</span> <span class="enscript-function-name">do_examine_patch_partition</span>(partition_map_header *map);
<span class="enscript-type">int</span> <span class="enscript-function-name">do_expert</span>(partition_map_header *map, <span class="enscript-type">char</span> *name);
<span class="enscript-type">void</span> <span class="enscript-function-name">do_rename_partition</span>(partition_map_header *map);
<span class="enscript-type">void</span> <span class="enscript-function-name">do_change_type</span>(partition_map_header *map);
<span class="enscript-type">void</span> <span class="enscript-function-name">do_reorder</span>(partition_map_header *map);
<span class="enscript-type">void</span> <span class="enscript-function-name">do_write_partition_map</span>(partition_map_header *map);
<span class="enscript-type">void</span> <span class="enscript-function-name">edit</span>(<span class="enscript-type">char</span> *name, <span class="enscript-type">int</span> ask_logical_size);
<span class="enscript-type">int</span> <span class="enscript-function-name">get_base_argument</span>(<span class="enscript-type">long</span> *number, partition_map_header *map);
<span class="enscript-type">int</span> <span class="enscript-function-name">get_command_line</span>(<span class="enscript-type">int</span> *argc, <span class="enscript-type">char</span> ***argv);
<span class="enscript-type">int</span> <span class="enscript-function-name">get_size_argument</span>(<span class="enscript-type">long</span> *number, partition_map_header *map);
<span class="enscript-type">int</span> <span class="enscript-function-name">get_options</span>(<span class="enscript-type">int</span> argc, <span class="enscript-type">char</span> **argv);
<span class="enscript-type">void</span> <span class="enscript-function-name">interact</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">void</span> <span class="enscript-function-name">print_edit_notes</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">void</span> <span class="enscript-function-name">print_expert_notes</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">void</span> <span class="enscript-function-name">print_top_notes</span>(<span class="enscript-type">void</span>);


<span class="enscript-comment">//
</span><span class="enscript-comment">// Routines
</span><span class="enscript-comment">//
</span><span class="enscript-type">int</span>
<span class="enscript-function-name">main</span>(<span class="enscript-type">int</span> argc, <span class="enscript-type">char</span> **argv)
{
#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__linux__</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__unix__</span>)
    <span class="enscript-type">int</span> name_index;
#<span class="enscript-reference">else</span>
    SIOUXSettings.rows = 100;
    printf(<span class="enscript-string">&quot;This app uses the SIOUX console library\n&quot;</span>);
    printf(<span class="enscript-string">&quot;Choose 'Quit' from the file menu to quit.\n\n&quot;</span>);
    printf(<span class="enscript-string">&quot;Use fake disk names (/dev/scsi&lt;bus&gt;.&lt;id&gt;; i.e. /dev/scsi0.1, /dev/scsi1.3, etc.).\n\n&quot;</span>);
 
    SIOUXSettings.autocloseonquit = 0;	<span class="enscript-comment">/* Do we close the SIOUX window on program termination ... */</span>
    SIOUXSettings.asktosaveonclose = 0;	<span class="enscript-comment">/* Do we offer to save on a close ... */</span>
#<span class="enscript-reference">endif</span>

    init_program_name(argv);

    <span class="enscript-keyword">if</span> (<span class="enscript-keyword">sizeof</span>(DPME) != PBLOCK_SIZE) {
	fatal(-1, <span class="enscript-string">&quot;Size of partition map entry (%d) &quot;</span>
		<span class="enscript-string">&quot;is not equal to block size (%d)\n&quot;</span>,
		<span class="enscript-keyword">sizeof</span>(DPME), PBLOCK_SIZE);
    }
    <span class="enscript-keyword">if</span> (<span class="enscript-keyword">sizeof</span>(Block0) != PBLOCK_SIZE) {
	fatal(-1, <span class="enscript-string">&quot;Size of block zero structure (%d) &quot;</span>
		<span class="enscript-string">&quot;is not equal to block size (%d)\n&quot;</span>,
		<span class="enscript-keyword">sizeof</span>(Block0), PBLOCK_SIZE);
    }
    <span class="enscript-keyword">if</span> (strcmp(VERSION, get_version_string()) != 0) {
	fatal(-1, <span class="enscript-string">&quot;Version string static form (%s) does not match dynamic form (%s)\n&quot;</span>,
		VERSION, get_version_string());
    }

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__linux__</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__unix__</span>)
    <span class="enscript-keyword">if</span> (argc &gt; 1) {
	do_command_line(argc - 1, argv + 1);
    }

    name_index = get_options(argc, argv);

    <span class="enscript-keyword">if</span> (vflag) {
	printf(<span class="enscript-string">&quot;version &quot;</span> VERSION <span class="enscript-string">&quot; (&quot;</span> RELEASE_DATE <span class="enscript-string">&quot;)\n&quot;</span>);
    }
    <span class="enscript-keyword">if</span> (hflag) {
 	do_help();
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (interactive) {
	interact();
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (lflag) {
	<span class="enscript-keyword">if</span> (lfile != NULL) {
	    dump(lfile);
	} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (name_index &lt; argc) {
	    <span class="enscript-keyword">while</span> (name_index &lt; argc) {
		dump(argv[name_index++]);
	    }
	} <span class="enscript-keyword">else</span> {
#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__linux__</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__APPLE__</span>)
	    list_all_disks();
#<span class="enscript-reference">else</span>
	    usage(<span class="enscript-string">&quot;no device argument&quot;</span>);
	    do_help();
#<span class="enscript-reference">endif</span>
	}
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (name_index &lt; argc) {
	interactive = 1;
	<span class="enscript-keyword">while</span> (name_index &lt; argc) {
	    edit(argv[name_index++], 0);
	}
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (!vflag) {
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">__APPLE__</span>
	interactive = 1;
	interact();
#<span class="enscript-reference">else</span>
	usage(<span class="enscript-string">&quot;no device argument&quot;</span>);
 	do_help();
#<span class="enscript-reference">endif</span>
    }
    <span class="enscript-keyword">return</span> 0;
#<span class="enscript-reference">else</span>
    interactive = 1;

    interact();

    SIOUXSettings.autocloseonquit = 1;
    <span class="enscript-comment">//printf(&quot;Processing stopped: Choose 'Quit' from the file menu to quit.\n\n&quot;);
</span>    exit(0);
#<span class="enscript-reference">endif</span>
}


<span class="enscript-type">void</span>
<span class="enscript-function-name">print_top_notes</span>()
{
#<span class="enscript-reference">if</span> !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__linux__</span>) &amp;&amp; !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__unix__</span>)
    printf(<span class="enscript-string">&quot;Notes:\n&quot;</span>);
    printf(<span class="enscript-string">&quot;  Disks have fake names of the form /dev/scsi&lt;bus&gt;.&lt;id&gt;\n&quot;</span>);
    printf(<span class="enscript-string">&quot;  For example, /dev/scsi0.1, /dev/scsi1.3, and so on.\n&quot;</span>);
    printf(<span class="enscript-string">&quot;  Linux style names are also allowed (i.e /dev/sda or /dev/hda).\n&quot;</span>);
    printf(<span class="enscript-string">&quot;  Due to some technical problems these names may not match\n&quot;</span>);
    printf(<span class="enscript-string">&quot;  the 'real' linux names.\n&quot;</span>);
    printf(<span class="enscript-string">&quot;\n&quot;</span>);
#<span class="enscript-reference">endif</span>
}


<span class="enscript-type">void</span>
<span class="enscript-function-name">interact</span>()
{
    <span class="enscript-type">char</span> *name;
    <span class="enscript-type">int</span> command;
    <span class="enscript-type">int</span> ask_logical_size;

    <span class="enscript-keyword">while</span> (get_command(<span class="enscript-string">&quot;Top level command (? for help): &quot;</span>, first_get, &amp;command)) {
	first_get = 0;
	ask_logical_size = 0;

	<span class="enscript-keyword">switch</span> (command) {
	<span class="enscript-keyword">case</span> <span class="enscript-string">'?'</span>:
	    print_top_notes();
	    <span class="enscript-comment">// fall through
</span>	<span class="enscript-keyword">case</span> <span class="enscript-string">'H'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'h'</span>:
	    printf(<span class="enscript-string">&quot;Commands are:\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  h    print help\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  v    print the version number and release date\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  l    list device's map\n&quot;</span>);
#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__linux__</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__APPLE__</span>)
	    printf(<span class="enscript-string">&quot;  L    list all devices' maps\n&quot;</span>);
#<span class="enscript-reference">endif</span>
	    printf(<span class="enscript-string">&quot;  e    edit device's map\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  E    (edit map with specified block size)\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  r    toggle readonly flag\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  f    toggle show filesystem name flag\n&quot;</span>);
	    <span class="enscript-keyword">if</span> (dflag) {
		printf(<span class="enscript-string">&quot;  a    toggle abbreviate flag\n&quot;</span>);
		printf(<span class="enscript-string">&quot;  p    toggle physical flag\n&quot;</span>);
		printf(<span class="enscript-string">&quot;  c    toggle compute size flag\n&quot;</span>);
		printf(<span class="enscript-string">&quot;  d    toggle debug flag\n&quot;</span>);
		printf(<span class="enscript-string">&quot;  x    examine block n of device\n&quot;</span>);
	    }
	    printf(<span class="enscript-string">&quot;  q    quit the program\n&quot;</span>);
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'Q'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'q'</span>:
	    <span class="enscript-keyword">return</span>;
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'V'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'v'</span>:
	    printf(<span class="enscript-string">&quot;version &quot;</span> VERSION <span class="enscript-string">&quot; (&quot;</span> RELEASE_DATE <span class="enscript-string">&quot;)\n&quot;</span>);
	    <span class="enscript-keyword">break</span>;
#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__linux__</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__APPLE__</span>)
	<span class="enscript-keyword">case</span> <span class="enscript-string">'L'</span>:
	    list_all_disks();
	    <span class="enscript-keyword">break</span>;
#<span class="enscript-reference">endif</span>
	<span class="enscript-keyword">case</span> <span class="enscript-string">'l'</span>:
	    <span class="enscript-keyword">if</span> (get_string_argument(<span class="enscript-string">&quot;Name of device: &quot;</span>, &amp;name, 1) == 0) {
		bad_input(<span class="enscript-string">&quot;Bad name&quot;</span>);
		<span class="enscript-keyword">break</span>;
	    }
	    dump(name);
	    free(name);
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'E'</span>:
	    ask_logical_size = 1;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'e'</span>:
	    <span class="enscript-keyword">if</span> (get_string_argument(<span class="enscript-string">&quot;Name of device: &quot;</span>, &amp;name, 1) == 0) {
		bad_input(<span class="enscript-string">&quot;Bad name&quot;</span>);
		<span class="enscript-keyword">break</span>;
	    }
	    edit(name, ask_logical_size);
	    free(name);
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'R'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'r'</span>:
	    <span class="enscript-keyword">if</span> (rflag) {
		rflag = 0;
	    } <span class="enscript-keyword">else</span> {
		rflag = 1;
	    }
	    printf(<span class="enscript-string">&quot;Now in %s mode.\n&quot;</span>, (rflag)?<span class="enscript-string">&quot;readonly&quot;</span>:<span class="enscript-string">&quot;read/write&quot;</span>);
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'F'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'f'</span>:
	    <span class="enscript-keyword">if</span> (fflag) {
		fflag = 0;
	    } <span class="enscript-keyword">else</span> {
		fflag = 1;
	    }
	    printf(<span class="enscript-string">&quot;Now in show %s name mode.\n&quot;</span>, (fflag)?<span class="enscript-string">&quot;filesystem&quot;</span>:<span class="enscript-string">&quot;partition&quot;</span>);
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'A'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'a'</span>:
	    <span class="enscript-keyword">if</span> (dflag) {
		<span class="enscript-keyword">if</span> (aflag) {
		    aflag = 0;
		} <span class="enscript-keyword">else</span> {
		    aflag = 1;
		}
		printf(<span class="enscript-string">&quot;Now in %s mode.\n&quot;</span>, (aflag)?<span class="enscript-string">&quot;abbreviate&quot;</span>:<span class="enscript-string">&quot;full type&quot;</span>);
	    } <span class="enscript-keyword">else</span> {
	    	<span class="enscript-keyword">goto</span> <span class="enscript-reference">do_error</span>;
	    }
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'P'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'p'</span>:
	    <span class="enscript-keyword">if</span> (dflag) {
		<span class="enscript-keyword">if</span> (pflag) {
		    pflag = 0;
		} <span class="enscript-keyword">else</span> {
		    pflag = 1;
		}
		printf(<span class="enscript-string">&quot;Now in %s mode.\n&quot;</span>, (pflag)?<span class="enscript-string">&quot;physical&quot;</span>:<span class="enscript-string">&quot;logical&quot;</span>);
	    } <span class="enscript-keyword">else</span> {
	    	<span class="enscript-keyword">goto</span> <span class="enscript-reference">do_error</span>;
	    }
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'D'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'d'</span>:
	    <span class="enscript-keyword">if</span> (dflag) {
		dflag = 0;
	    } <span class="enscript-keyword">else</span> {
		dflag = 1;
	    }
	    printf(<span class="enscript-string">&quot;Now in %s mode.\n&quot;</span>, (dflag)?<span class="enscript-string">&quot;debug&quot;</span>:<span class="enscript-string">&quot;normal&quot;</span>);
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'C'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'c'</span>:
	    <span class="enscript-keyword">if</span> (dflag) {
		<span class="enscript-keyword">if</span> (cflag) {
		    cflag = 0;
		} <span class="enscript-keyword">else</span> {
		    cflag = 1;
		}
		printf(<span class="enscript-string">&quot;Now in %s device size mode.\n&quot;</span>, (cflag)?<span class="enscript-string">&quot;always compute&quot;</span>:<span class="enscript-string">&quot;use existing&quot;</span>);
	    } <span class="enscript-keyword">else</span> {
	    	<span class="enscript-keyword">goto</span> <span class="enscript-reference">do_error</span>;
	    }
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'X'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'x'</span>:
	    <span class="enscript-keyword">if</span> (dflag) {
		do_display_block(0, 0);
	    } <span class="enscript-keyword">else</span> {
	    	<span class="enscript-keyword">goto</span> <span class="enscript-reference">do_error</span>;
	    }
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-reference">default</span>:
	<span class="enscript-reference">do_error</span>:
	    bad_input(<span class="enscript-string">&quot;No such command (%c)&quot;</span>, command);
	    <span class="enscript-keyword">break</span>;
	}
    }
}


#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__linux__</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__unix__</span>)
<span class="enscript-type">int</span>
<span class="enscript-function-name">get_options</span>(<span class="enscript-type">int</span> argc, <span class="enscript-type">char</span> **argv)
{
    <span class="enscript-type">int</span> c;
#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__linux__</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__unix__</span>)
    <span class="enscript-type">static</span> <span class="enscript-type">struct</span> option long_options[] =
    {
	<span class="enscript-comment">// name		has_arg			&amp;flag	val
</span>	{<span class="enscript-string">&quot;help&quot;</span>,	no_argument,		0,	<span class="enscript-string">'h'</span>},
	{<span class="enscript-string">&quot;list&quot;</span>,	optional_argument,	0,	kListOption},
	{<span class="enscript-string">&quot;version&quot;</span>,	no_argument,		0,	<span class="enscript-string">'v'</span>},
	{<span class="enscript-string">&quot;debug&quot;</span>,	no_argument,		0,	<span class="enscript-string">'d'</span>},
	{<span class="enscript-string">&quot;readonly&quot;</span>,	no_argument,		0,	<span class="enscript-string">'r'</span>},
	{<span class="enscript-string">&quot;abbr&quot;</span>,	no_argument,		0,	<span class="enscript-string">'a'</span>},
	{<span class="enscript-string">&quot;fname&quot;</span>,	no_argument,		0,	<span class="enscript-string">'f'</span>},
	{<span class="enscript-string">&quot;logical&quot;</span>,	no_argument,		0,	kLogicalOption},
	{<span class="enscript-string">&quot;interactive&quot;</span>,	no_argument,		0,	<span class="enscript-string">'i'</span>},
	{<span class="enscript-string">&quot;compute_size&quot;</span>, no_argument,		0,	<span class="enscript-string">'c'</span>},
	{0, 0, 0, 0}
    };
    <span class="enscript-type">int</span> option_index = 0;
#<span class="enscript-reference">else</span>
    <span class="enscript-type">extern</span> <span class="enscript-type">int</span> opterr;		<span class="enscript-comment">/* who does error messages */</span>
    <span class="enscript-type">extern</span> <span class="enscript-type">int</span> optopt;		<span class="enscript-comment">/* char that caused the error */</span>
    <span class="enscript-type">int</span> getopt_error;		<span class="enscript-comment">/* getopt choked */</span>
#<span class="enscript-reference">endif</span>
    <span class="enscript-type">extern</span> <span class="enscript-type">int</span> optind;		<span class="enscript-comment">/* next argv index */</span>
    <span class="enscript-type">extern</span> <span class="enscript-type">char</span> *optarg;	<span class="enscript-comment">/* pointer to argument */</span>
    <span class="enscript-type">int</span> flag = 0;

    lflag = LFLAG_DEFAULT;
    lfile = NULL;
    vflag = VFLAG_DEFAULT;
    hflag = HFLAG_DEFAULT;
    dflag = DFLAG_DEFAULT;
    rflag = RFLAG_DEFAULT;
    aflag = AFLAG_DEFAULT;
    pflag = PFLAG_DEFAULT;
    interactive = INTERACT_DEFAULT;
    cflag = CFLAG_DEFAULT;
    fflag = FFLAG_DEFAULT;

#<span class="enscript-reference">if</span> <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__linux__</span>) || <span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__unix__</span>)
    optind = 0;	<span class="enscript-comment">// reset option scanner logic
</span>    <span class="enscript-keyword">while</span> ((c = getopt_long(argc, argv, <span class="enscript-string">&quot;hlvdraLicf&quot;</span>, long_options,
	    &amp;option_index)) &gt;= 0)
#<span class="enscript-reference">else</span>
    opterr = 0;			<span class="enscript-comment">/* tell getopt to be quiet */</span>
    <span class="enscript-keyword">while</span> ((c = getopt(argc, argv, <span class="enscript-string">&quot;hlvdraLicf&quot;</span>)) != EOF)
#<span class="enscript-reference">endif</span>
	{
#<span class="enscript-reference">if</span> !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__linux__</span>) &amp;&amp; !<span class="enscript-reference">defined</span>(<span class="enscript-variable-name">__unix__</span>)
	<span class="enscript-keyword">if</span> (c == <span class="enscript-string">'?'</span>) {
	    getopt_error = 1;
	    c = optopt;
	} <span class="enscript-keyword">else</span> {
	    getopt_error = 0;
	}
#<span class="enscript-reference">endif</span>
	<span class="enscript-keyword">switch</span> (c) {
	<span class="enscript-keyword">case</span> <span class="enscript-reference">kLongOption</span>:
	    <span class="enscript-comment">// option_index would be used here
</span>	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'h'</span>:
	    hflag = (HFLAG_DEFAULT)?0:1;
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-reference">kListOption</span>:
	    <span class="enscript-keyword">if</span> (optarg != NULL) {
		lfile = optarg;
	    }
	    <span class="enscript-comment">// fall through
</span>	<span class="enscript-keyword">case</span> <span class="enscript-string">'l'</span>:
	    lflag = (LFLAG_DEFAULT)?0:1;
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'v'</span>:
	    vflag = (VFLAG_DEFAULT)?0:1;
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'d'</span>:
	    dflag = (DFLAG_DEFAULT)?0:1;
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'c'</span>:
	    cflag = (CFLAG_DEFAULT)?0:1;
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'r'</span>:
	    rflag = (RFLAG_DEFAULT)?0:1;
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'f'</span>:
	    fflag = (FFLAG_DEFAULT)?0:1;
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'i'</span>:
	    interactive = (INTERACT_DEFAULT)?0:1;
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'a'</span>:
	    aflag = (AFLAG_DEFAULT)?0:1;
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'L'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-reference">kLogicalOption</span>:
	    pflag = (PFLAG_DEFAULT)?0:1;
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-reference">kBadOption</span>:
	<span class="enscript-reference">default</span>:
	    flag = 1;
	    <span class="enscript-keyword">break</span>;
	}
    }
    <span class="enscript-keyword">if</span> (flag) {
	usage(<span class="enscript-string">&quot;bad arguments&quot;</span>);
    }
    <span class="enscript-keyword">return</span> optind;
}
#<span class="enscript-reference">endif</span>


<span class="enscript-type">void</span>
<span class="enscript-function-name">print_edit_notes</span>()
{
    printf(<span class="enscript-string">&quot;Notes:\n&quot;</span>);
    printf(<span class="enscript-string">&quot;  Base and length fields are blocks, which vary in size between media.\n&quot;</span>);
    printf(<span class="enscript-string">&quot;  The base field can be &lt;nth&gt;p; i.e. use the base of the nth partition.\n&quot;</span>);
    printf(<span class="enscript-string">&quot;  The length field can be a length followed by k, m, g or t to indicate\n&quot;</span>);
    printf(<span class="enscript-string">&quot;  kilo, mega, giga, or tera bytes; also the length can be &lt;nth&gt;p; i.e. use\n&quot;</span>);
    printf(<span class="enscript-string">&quot;  the length of the nth partition.\n&quot;</span>);
    printf(<span class="enscript-string">&quot;  The name of a partition is descriptive text.\n&quot;</span>);
    printf(<span class="enscript-string">&quot;\n&quot;</span>);
}


<span class="enscript-comment">//
</span><span class="enscript-comment">// Edit the file
</span><span class="enscript-comment">//
</span><span class="enscript-type">void</span>
<span class="enscript-function-name">edit</span>(<span class="enscript-type">char</span> *name, <span class="enscript-type">int</span> ask_logical_size)
{
    partition_map_header *map;
    <span class="enscript-type">int</span> command;
    <span class="enscript-type">int</span> order;
    <span class="enscript-type">int</span> get_type;
    <span class="enscript-type">int</span> valid_file;

    map = open_partition_map(name, &amp;valid_file, ask_logical_size, (rflag)?O_RDONLY:O_RDWR);
    <span class="enscript-keyword">if</span> (!valid_file) {
    	<span class="enscript-keyword">return</span>;
    }

    printf(<span class="enscript-string">&quot;Edit %s -\n&quot;</span>, name);
    
#<span class="enscript-reference">if</span> 0 <span class="enscript-comment">/* this check is not found in linux fdisk-0.1 */</span>
    <span class="enscript-keyword">if</span> (map != NULL &amp;&amp; map-&gt;blocks_in_map &gt; MAX_LINUX_MAP) {
	error(-1, <span class="enscript-string">&quot;Map contains more than %d blocks - Linux may have trouble&quot;</span>, MAX_LINUX_MAP);
    }
#<span class="enscript-reference">endif</span>

    <span class="enscript-keyword">while</span> (get_command(<span class="enscript-string">&quot;Command (? for help): &quot;</span>, first_get, &amp;command)) {
	first_get = 0;
	order = 1;
	get_type = 0;

	<span class="enscript-keyword">switch</span> (command) {
	<span class="enscript-keyword">case</span> <span class="enscript-string">'?'</span>:
	    print_edit_notes();
	    <span class="enscript-comment">// fall through
</span>	<span class="enscript-keyword">case</span> <span class="enscript-string">'H'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'h'</span>:
	    printf(<span class="enscript-string">&quot;Commands are:\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  C    (create with type also specified)\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  c    create new partition (standard type)\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  d    delete a partition\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  h    help\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  i    initialize partition map\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  n    (re)name a partition\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  P    (print ordered by base address)\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  p    print the partition table\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  q    quit editing\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  r    reorder partition entry in map\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  s    change size of partition map\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  t    change a partition's type\n&quot;</span>);
	    <span class="enscript-keyword">if</span> (!rflag) {
		printf(<span class="enscript-string">&quot;  w    write the partition table\n&quot;</span>);
	    }
	    <span class="enscript-keyword">if</span> (dflag) {
		printf(<span class="enscript-string">&quot;  x    extra extensions for experts\n&quot;</span>);
	    }
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'P'</span>:
	    order = 0;
	    <span class="enscript-comment">// fall through
</span>	<span class="enscript-keyword">case</span> <span class="enscript-string">'p'</span>:
	    dump_partition_map(map, order);
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'Q'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'q'</span>:
	    <span class="enscript-keyword">if</span> (map &amp;&amp; map-&gt;changed) {
		<span class="enscript-keyword">if</span> (get_okay(<span class="enscript-string">&quot;Discard changes? [n/y]: &quot;</span>, 0) != 1) {
		    <span class="enscript-keyword">break</span>;
		}
	    }
	    flush_to_newline(1);
	    <span class="enscript-keyword">goto</span> <span class="enscript-reference">finis</span>;
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'I'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'i'</span>:
	    map = init_partition_map(name, map, (rflag)?O_RDONLY:O_RDWR);
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'C'</span>:
	    get_type = 1;
	    <span class="enscript-comment">// fall through
</span>	<span class="enscript-keyword">case</span> <span class="enscript-string">'c'</span>:
	    do_create_partition(map, get_type);
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'N'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'n'</span>:
	    do_rename_partition(map);
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'D'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'d'</span>:
	    do_delete_partition(map);
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'R'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'r'</span>:
	    do_reorder(map);
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'S'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'s'</span>:
	    do_change_map_size(map);
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'T'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'t'</span>:
	    do_change_type(map);
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'X'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'x'</span>:
	    <span class="enscript-keyword">if</span> (!dflag) {
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">do_error</span>;
	    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (do_expert(map, name)) {
		flush_to_newline(1);
		<span class="enscript-keyword">goto</span> <span class="enscript-reference">finis</span>;
	    }
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'W'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'w'</span>:
	    <span class="enscript-keyword">if</span> (!rflag) {
		do_write_partition_map(map);
	    } <span class="enscript-keyword">else</span> {
	    	<span class="enscript-keyword">goto</span> <span class="enscript-reference">do_error</span>;
	    }
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-reference">default</span>:
	<span class="enscript-reference">do_error</span>:
	    bad_input(<span class="enscript-string">&quot;No such command (%c)&quot;</span>, command);
	    <span class="enscript-keyword">break</span>;
	}
    }
<span class="enscript-reference">finis</span>:

    close_partition_map(map);
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">do_update_dpme</span>(partition_map *entry)
{
    <span class="enscript-type">int</span> slice = 0;
    <span class="enscript-keyword">if</span> (!entry) <span class="enscript-keyword">return</span>;
    dpme_init_flags(entry-&gt;data);
    entry-&gt;HFS_name = get_HFS_name(entry, &amp;entry-&gt;HFS_kind);
    <span class="enscript-keyword">if</span> (istrncmp(entry-&gt;data-&gt;dpme_type, kUnixType, DPISTRLEN) == 0) {
	printf(<span class="enscript-string">&quot;Available partition slices for %s:\n&quot;</span>,entry-&gt;data-&gt;dpme_type);
	printf(<span class="enscript-string">&quot;  a   root partition\n&quot;</span>);
	printf(<span class="enscript-string">&quot;  b   swap partition\n&quot;</span>);
	printf(<span class="enscript-string">&quot;  c   do not set any bzb bits\n&quot;</span>);
	printf(<span class="enscript-string">&quot;  g   user partition\n&quot;</span>);
	printf(<span class="enscript-string">&quot;Other lettered values will create user partitions\n&quot;</span>);
	get_command(<span class="enscript-string">&quot;Select a slice for default bzb values: &quot;</span>,0,&amp;slice);
    }
    bzb_init_slice((BZB *)entry-&gt;data-&gt;dpme_bzb,slice);
    entry-&gt;the_map-&gt;changed = 1;
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">do_create_partition</span>(partition_map_header *map, <span class="enscript-type">int</span> get_type)
{
    <span class="enscript-type">long</span> base;
    <span class="enscript-type">long</span> length;
    <span class="enscript-type">char</span> *name = 0;
    <span class="enscript-type">char</span> *type_name = 0;

    <span class="enscript-keyword">if</span> (map == NULL) {
	bad_input(<span class="enscript-string">&quot;No partition map exists&quot;</span>);
	<span class="enscript-keyword">return</span>;
    }
    <span class="enscript-keyword">if</span> (!rflag &amp;&amp; map-&gt;writable == 0) {
	printf(<span class="enscript-string">&quot;The map is not writable.\n&quot;</span>);
    }
<span class="enscript-comment">// XXX add help feature (i.e. '?' in any argument routine prints help string)
</span>    <span class="enscript-keyword">if</span> (get_base_argument(&amp;base, map) == 0) {
	<span class="enscript-keyword">return</span>;
    }
    <span class="enscript-keyword">if</span> (get_size_argument(&amp;length, map) == 0) {
	<span class="enscript-keyword">return</span>;
    }

    <span class="enscript-keyword">if</span> (get_string_argument(<span class="enscript-string">&quot;Name of partition: &quot;</span>, &amp;name, 1) == 0) {
	bad_input(<span class="enscript-string">&quot;Bad name&quot;</span>);
	<span class="enscript-keyword">return</span>;
    }
    <span class="enscript-keyword">if</span> (get_type == 0) {
#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">__APPLE__</span>
	add_partition_to_map(name, kHFSType, base, length, map);
#<span class="enscript-reference">else</span>
	add_partition_to_map(name, kUnixType, base, length, map);
#<span class="enscript-reference">endif</span>
#<span class="enscript-reference">if</span> 0 <span class="enscript-comment">/* this check is not found in linux fdisk-0.1 */</span>
	<span class="enscript-keyword">if</span> (map-&gt;blocks_in_map &gt; MAX_LINUX_MAP) {
	    error(-1, <span class="enscript-string">&quot;Map contains more than %d blocks - Linux may have trouble&quot;</span>, MAX_LINUX_MAP);
	}
	<span class="enscript-keyword">goto</span> <span class="enscript-reference">xit1</span>;
#<span class="enscript-reference">endif</span>
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (get_string_argument(<span class="enscript-string">&quot;Type of partition: &quot;</span>, &amp;type_name, 1) == 0) {
	bad_input(<span class="enscript-string">&quot;Bad type&quot;</span>);
	<span class="enscript-keyword">goto</span> <span class="enscript-reference">xit1</span>;
    } <span class="enscript-keyword">else</span> {
	<span class="enscript-keyword">if</span> (istrncmp(type_name, kFreeType, DPISTRLEN) == 0) {
	    bad_input(<span class="enscript-string">&quot;Can't create a partition with the Free type&quot;</span>);
	    <span class="enscript-keyword">goto</span> <span class="enscript-reference">xit2</span>;
	}
	<span class="enscript-keyword">if</span> (istrncmp(type_name, kMapType, DPISTRLEN) == 0) {
	    bad_input(<span class="enscript-string">&quot;Can't create a partition with the Map type&quot;</span>);
	    <span class="enscript-keyword">goto</span> <span class="enscript-reference">xit2</span>;
	}
	add_partition_to_map(name, type_name, base, length, map);
#<span class="enscript-reference">if</span> 0 <span class="enscript-comment">/* this check is not found in linux fdisk-0.1 */</span>
	<span class="enscript-keyword">if</span> (map-&gt;blocks_in_map &gt; MAX_LINUX_MAP) {
	    error(-1, <span class="enscript-string">&quot;Map contains more than %d blocks - Linux may have trouble&quot;</span>, MAX_LINUX_MAP);
	}
#<span class="enscript-reference">endif</span>
    }
    do_update_dpme(find_entry_by_base(base,map));
<span class="enscript-reference">xit2</span>:
    <span class="enscript-keyword">if</span> (type_name)
        free(type_name);
<span class="enscript-reference">xit1</span>:
    <span class="enscript-keyword">if</span> (name)
        free(name);
    <span class="enscript-keyword">return</span>;
}


<span class="enscript-type">int</span>
<span class="enscript-function-name">get_base_argument</span>(<span class="enscript-type">long</span> *number, partition_map_header *map)
{
    partition_map * entry;
    <span class="enscript-type">int</span> result = 0;

    <span class="enscript-keyword">if</span> (get_number_argument(<span class="enscript-string">&quot;First block: &quot;</span>, number, kDefault) == 0) {
	bad_input(<span class="enscript-string">&quot;Bad block number&quot;</span>);
    } <span class="enscript-keyword">else</span> {
	result = 1;
	<span class="enscript-keyword">if</span> (get_partition_modifier()) {
	    entry = find_entry_by_disk_address(*number, map);
	    <span class="enscript-keyword">if</span> (entry == NULL) {
		bad_input(<span class="enscript-string">&quot;Bad partition number&quot;</span>);
		result = 0;
	    } <span class="enscript-keyword">else</span> {
		*number = entry-&gt;data-&gt;dpme_pblock_start;
	    }
	}
    }
    <span class="enscript-keyword">return</span> result;
}


<span class="enscript-type">int</span>
<span class="enscript-function-name">get_size_argument</span>(<span class="enscript-type">long</span> *number, partition_map_header *map)
{
    partition_map * entry;
    <span class="enscript-type">int</span> result = 0;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> multiple;

    <span class="enscript-keyword">if</span> (get_number_argument(<span class="enscript-string">&quot;Length in blocks: &quot;</span>, number, kDefault) == 0) {
	bad_input(<span class="enscript-string">&quot;Bad length&quot;</span>);
    } <span class="enscript-keyword">else</span> {
	multiple = get_multiplier(map-&gt;logical_block);
	<span class="enscript-keyword">if</span> (multiple == 0) {
	    bad_input(<span class="enscript-string">&quot;Bad multiplier&quot;</span>);
	} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (multiple != 1) {
	    *number *= multiple;
	    result = 1;
	} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (get_partition_modifier()) {
	    entry = find_entry_by_disk_address(*number, map);
	    <span class="enscript-keyword">if</span> (entry == NULL) {
		bad_input(<span class="enscript-string">&quot;Bad partition number&quot;</span>);
	    } <span class="enscript-keyword">else</span> {
		*number = entry-&gt;data-&gt;dpme_pblocks;
		result = 1;
	    }
	} <span class="enscript-keyword">else</span> {
	    result = 1;
	}
    }
    <span class="enscript-keyword">return</span> result;
}


<span class="enscript-type">void</span>
<span class="enscript-function-name">do_rename_partition</span>(partition_map_header *map)
{
    partition_map * entry;
    <span class="enscript-type">long</span> ix;
    <span class="enscript-type">char</span> *name;

    <span class="enscript-keyword">if</span> (map == NULL) {
	bad_input(<span class="enscript-string">&quot;No partition map exists&quot;</span>);
	<span class="enscript-keyword">return</span>;
    }
    <span class="enscript-keyword">if</span> (!rflag &amp;&amp; map-&gt;writable == 0) {
	printf(<span class="enscript-string">&quot;The map is not writable.\n&quot;</span>);
    }
    <span class="enscript-keyword">if</span> (get_number_argument(<span class="enscript-string">&quot;Partition number: &quot;</span>, &amp;ix, kDefault) == 0) {
	bad_input(<span class="enscript-string">&quot;Bad partition number&quot;</span>);
	<span class="enscript-keyword">return</span>;
    }
    <span class="enscript-keyword">if</span> (get_string_argument(<span class="enscript-string">&quot;New name of partition: &quot;</span>, &amp;name, 1) == 0) {
	bad_input(<span class="enscript-string">&quot;Bad name&quot;</span>);
	<span class="enscript-keyword">return</span>;
    }

	<span class="enscript-comment">// find partition and change it
</span>    entry = find_entry_by_disk_address(ix, map);
    <span class="enscript-keyword">if</span> (entry == NULL) {
	printf(<span class="enscript-string">&quot;No such partition\n&quot;</span>);
    } <span class="enscript-keyword">else</span> {
	<span class="enscript-comment">// stuff name into partition map entry data
</span>	strncpy(entry-&gt;data-&gt;dpme_name, name, DPISTRLEN);
	map-&gt;changed = 1;
    }
    free(name);
    <span class="enscript-keyword">return</span>;
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">do_change_type</span>(partition_map_header *map)
{
    partition_map * entry;
    <span class="enscript-type">long</span> ix;
    <span class="enscript-type">char</span> *type = NULL;

    <span class="enscript-keyword">if</span> (map == NULL) {
	bad_input(<span class="enscript-string">&quot;No partition map exists&quot;</span>);
	<span class="enscript-keyword">return</span>;
    }

    <span class="enscript-keyword">if</span> (!rflag &amp;&amp; map-&gt;writable == 0) {
	printf(<span class="enscript-string">&quot;The map is not writable.\n&quot;</span>);
    }

    <span class="enscript-keyword">if</span> (get_number_argument(<span class="enscript-string">&quot;Partition number: &quot;</span>, &amp;ix, kDefault) == 0) {
	bad_input(<span class="enscript-string">&quot;Bad partition number&quot;</span>);
	<span class="enscript-keyword">return</span>;
    }

    entry = find_entry_by_disk_address(ix, map);

    <span class="enscript-keyword">if</span> (entry == NULL ) {
        printf(<span class="enscript-string">&quot;No such partition\n&quot;</span>);
	<span class="enscript-keyword">goto</span> <span class="enscript-reference">out</span>;
    }

    printf(<span class="enscript-string">&quot;Existing partition type ``%s''.\n&quot;</span>, entry-&gt;data-&gt;dpme_type);
    <span class="enscript-keyword">if</span> (get_string_argument(<span class="enscript-string">&quot;New type of partition: &quot;</span>, &amp;type, 1) == 0) {
	bad_input(<span class="enscript-string">&quot;Bad type&quot;</span>);
	<span class="enscript-keyword">goto</span> <span class="enscript-reference">out</span>;
    }

    strncpy(entry-&gt;data-&gt;dpme_type, type, DPISTRLEN);
    do_update_dpme(entry);
    map-&gt;changed = 1;

<span class="enscript-reference">out</span>:
    <span class="enscript-keyword">if</span> (type)
        free(type);
    <span class="enscript-keyword">return</span>;
}


<span class="enscript-type">void</span>
<span class="enscript-function-name">do_delete_partition</span>(partition_map_header *map)
{
    partition_map * cur;
    <span class="enscript-type">long</span> ix;

    <span class="enscript-keyword">if</span> (map == NULL) {
	bad_input(<span class="enscript-string">&quot;No partition map exists&quot;</span>);
	<span class="enscript-keyword">return</span>;
    }
    <span class="enscript-keyword">if</span> (!rflag &amp;&amp; map-&gt;writable == 0) {
	printf(<span class="enscript-string">&quot;The map is not writable.\n&quot;</span>);
    }
    <span class="enscript-keyword">if</span> (get_number_argument(<span class="enscript-string">&quot;Partition number: &quot;</span>, &amp;ix, kDefault) == 0) {
	bad_input(<span class="enscript-string">&quot;Bad partition number&quot;</span>);
	<span class="enscript-keyword">return</span>;
    }

	<span class="enscript-comment">// find partition and delete it
</span>    cur = find_entry_by_disk_address(ix, map);
    <span class="enscript-keyword">if</span> (cur == NULL) {
	printf(<span class="enscript-string">&quot;No such partition\n&quot;</span>);
    } <span class="enscript-keyword">else</span> {
	delete_partition_from_map(cur);
    }
}


<span class="enscript-type">void</span>
<span class="enscript-function-name">do_reorder</span>(partition_map_header *map)
{
    <span class="enscript-type">long</span> old_index;
    <span class="enscript-type">long</span> ix;

    <span class="enscript-keyword">if</span> (map == NULL) {
	bad_input(<span class="enscript-string">&quot;No partition map exists&quot;</span>);
	<span class="enscript-keyword">return</span>;
    }
    <span class="enscript-keyword">if</span> (!rflag &amp;&amp; map-&gt;writable == 0) {
	printf(<span class="enscript-string">&quot;The map is not writable.\n&quot;</span>);
    }
    <span class="enscript-keyword">if</span> (get_number_argument(<span class="enscript-string">&quot;Partition number: &quot;</span>, &amp;old_index, kDefault) == 0) {
	bad_input(<span class="enscript-string">&quot;Bad partition number&quot;</span>);
	<span class="enscript-keyword">return</span>;
    }
    <span class="enscript-keyword">if</span> (get_number_argument(<span class="enscript-string">&quot;New number: &quot;</span>, &amp;ix, kDefault) == 0) {
	bad_input(<span class="enscript-string">&quot;Bad partition number&quot;</span>);
	<span class="enscript-keyword">return</span>;
    }

    move_entry_in_map(old_index, ix, map);
}


<span class="enscript-type">void</span>
<span class="enscript-function-name">do_write_partition_map</span>(partition_map_header *map)
{
    <span class="enscript-keyword">if</span> (map == NULL) {
	bad_input(<span class="enscript-string">&quot;No partition map exists&quot;</span>);
	<span class="enscript-keyword">return</span>;
    }
    <span class="enscript-keyword">if</span> (map-&gt;changed == 0 &amp;&amp; map-&gt;written == 0) {
	bad_input(<span class="enscript-string">&quot;The map has not been changed.&quot;</span>);
	<span class="enscript-keyword">return</span>;
    }
    <span class="enscript-keyword">if</span> (map-&gt;writable == 0) {
	bad_input(<span class="enscript-string">&quot;The map is not writable.&quot;</span>);
	<span class="enscript-keyword">return</span>;
    }
#<span class="enscript-reference">if</span> 0 <span class="enscript-comment">/* this check is not found in linux fdisk-0.1 */</span>
    <span class="enscript-keyword">if</span> (map-&gt;blocks_in_map &gt; MAX_LINUX_MAP) {
	error(-1, <span class="enscript-string">&quot;Map contains more than %d blocks - Linux may have trouble&quot;</span>, MAX_LINUX_MAP);
    }
#<span class="enscript-reference">endif</span>
    printf(<span class="enscript-string">&quot;Writing the map destroys what was there before. &quot;</span>);
    <span class="enscript-keyword">if</span> (get_okay(<span class="enscript-string">&quot;Is that okay? [n/y]: &quot;</span>, 0) != 1) {
	<span class="enscript-keyword">return</span>;
    }

    write_partition_map(map);
    
    map-&gt;changed = 0;
    map-&gt;written = 1;

    <span class="enscript-comment">// exit(0);
</span>}


<span class="enscript-type">void</span>
<span class="enscript-function-name">print_expert_notes</span>()
{
    printf(<span class="enscript-string">&quot;Notes:\n&quot;</span>);
    printf(<span class="enscript-string">&quot;  The expert commands are for low level and experimental features.\n&quot;</span>);
    printf(<span class="enscript-string">&quot;  These commands are available only when debug mode is on.\n&quot;</span>);
    printf(<span class="enscript-string">&quot;\n&quot;</span>);
}


<span class="enscript-type">int</span>
<span class="enscript-function-name">do_expert</span>(partition_map_header *map, <span class="enscript-type">char</span> *name)
{
    <span class="enscript-type">int</span> command;
    <span class="enscript-type">int</span> quit = 0;

    <span class="enscript-keyword">while</span> (get_command(<span class="enscript-string">&quot;Expert command (? for help): &quot;</span>, first_get, &amp;command)) {
	first_get = 0;

	<span class="enscript-keyword">switch</span> (command) {
	<span class="enscript-keyword">case</span> <span class="enscript-string">'?'</span>:
	    print_expert_notes();
	    <span class="enscript-comment">// fall through
</span>	<span class="enscript-keyword">case</span> <span class="enscript-string">'H'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'h'</span>:
	    printf(<span class="enscript-string">&quot;Commands are:\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  h    print help\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  d    dump block n\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  p    print the partition table\n&quot;</span>);
	    <span class="enscript-keyword">if</span> (dflag) {
		printf(<span class="enscript-string">&quot;  P    (show data structures  - debugging)\n&quot;</span>);
	    }
	    printf(<span class="enscript-string">&quot;  f    full display of nth entry\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  v    validate map\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  e    examine patch partition\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  q    return to main edit menu\n&quot;</span>);
	    printf(<span class="enscript-string">&quot;  Q    quit editing\n&quot;</span>);
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'q'</span>:
	    flush_to_newline(1);
	    <span class="enscript-keyword">goto</span> <span class="enscript-reference">finis</span>;
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'Q'</span>:
	    <span class="enscript-keyword">if</span> (map-&gt;changed) {
		<span class="enscript-keyword">if</span> (get_okay(<span class="enscript-string">&quot;Discard changes? [n/y]: &quot;</span>, 0) != 1) {
		    <span class="enscript-keyword">break</span>;
		}
	    }
	    quit = 1;
	    <span class="enscript-keyword">goto</span> <span class="enscript-reference">finis</span>;
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'P'</span>:
	    <span class="enscript-keyword">if</span> (dflag) {
		show_data_structures(map);
		<span class="enscript-keyword">break</span>;
	    }
	    <span class="enscript-comment">// fall through
</span>	<span class="enscript-keyword">case</span> <span class="enscript-string">'p'</span>:
	    dump_partition_map(map, 1);
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'D'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'d'</span>:
	    do_display_block(map, name);
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'F'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'f'</span>:
	    do_display_entry(map);
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'V'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'v'</span>:
	    validate_map(map);
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-keyword">case</span> <span class="enscript-string">'E'</span>:
	<span class="enscript-keyword">case</span> <span class="enscript-string">'e'</span>:
	    do_examine_patch_partition(map);
	    <span class="enscript-keyword">break</span>;
	<span class="enscript-reference">default</span>:
	    bad_input(<span class="enscript-string">&quot;No such command (%c)&quot;</span>, command);
	    <span class="enscript-keyword">break</span>;
	}
    }
<span class="enscript-reference">finis</span>:
    <span class="enscript-keyword">return</span> quit;
}

<span class="enscript-type">void</span>
<span class="enscript-function-name">do_change_map_size</span>(partition_map_header *map)
{
    <span class="enscript-type">long</span> size;

    <span class="enscript-keyword">if</span> (map == NULL) {
	bad_input(<span class="enscript-string">&quot;No partition map exists&quot;</span>);
	<span class="enscript-keyword">return</span>;
    }
    <span class="enscript-keyword">if</span> (!rflag &amp;&amp; map-&gt;writable == 0) {
	printf(<span class="enscript-string">&quot;The map is not writable.\n&quot;</span>);
    }
    <span class="enscript-keyword">if</span> (get_number_argument(<span class="enscript-string">&quot;New size: &quot;</span>, &amp;size, kDefault) == 0) {
	bad_input(<span class="enscript-string">&quot;Bad size&quot;</span>);
	<span class="enscript-keyword">return</span>;
    }
    resize_map(size, map);
}


<span class="enscript-type">void</span>
<span class="enscript-function-name">do_display_block</span>(partition_map_header *map, <span class="enscript-type">char</span> *alt_name)
{
    MEDIA m;
    <span class="enscript-type">long</span> number;
    <span class="enscript-type">char</span> *name;
    <span class="enscript-type">static</span> <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *display_block;
    <span class="enscript-type">static</span> <span class="enscript-type">int</span> display_g;
    <span class="enscript-type">int</span> g;
    <span class="enscript-type">static</span> <span class="enscript-type">long</span> next_number = -1;

    <span class="enscript-keyword">if</span> (map != NULL) {
    	name = 0;
	m = map-&gt;m;
	g = map-&gt;logical_block;
    } <span class="enscript-keyword">else</span> {
	<span class="enscript-keyword">if</span> (alt_name == 0) {
	    <span class="enscript-keyword">if</span> (get_string_argument(<span class="enscript-string">&quot;Name of device: &quot;</span>, &amp;name, 1) == 0) {
		bad_input(<span class="enscript-string">&quot;Bad name&quot;</span>);
		<span class="enscript-keyword">return</span>;
	    }
	} <span class="enscript-keyword">else</span> {
	    name = strdup(alt_name);
	}
	m = open_pathname_as_media(name, O_RDONLY);
	<span class="enscript-keyword">if</span> (m == 0) {
	    error(errno, <span class="enscript-string">&quot;can't open file '%s'&quot;</span>, name);
	    free(name);
	    <span class="enscript-keyword">return</span>;
	}
	g = media_granularity(m);
	<span class="enscript-keyword">if</span> (g &lt; PBLOCK_SIZE) {
	    g = PBLOCK_SIZE;
	}
    }
    <span class="enscript-keyword">if</span> (get_number_argument(<span class="enscript-string">&quot;Block number: &quot;</span>, &amp;number, next_number) == 0) {
	bad_input(<span class="enscript-string">&quot;Bad block number&quot;</span>);
	<span class="enscript-keyword">goto</span> <span class="enscript-reference">xit</span>;
    }
    <span class="enscript-keyword">if</span> (display_block == NULL || display_g &lt; g) {
    	<span class="enscript-keyword">if</span> (display_block != NULL) {
    	    free(display_block);
    	    display_g = 0;
	}
	display_block = (<span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *) malloc(g);
	<span class="enscript-keyword">if</span> (display_block == NULL) {
	    error(errno, <span class="enscript-string">&quot;can't allocate memory for display block buffer&quot;</span>);
	    <span class="enscript-keyword">goto</span> <span class="enscript-reference">xit</span>;
	}
	display_g = g;
    }
    <span class="enscript-keyword">if</span> (read_media(m, ((<span class="enscript-type">long</span> <span class="enscript-type">long</span>)number) * g, g, (<span class="enscript-type">char</span> *)display_block) != 0) {
	printf(<span class="enscript-string">&quot;block %ld -&quot;</span>, number);
	dump_block((<span class="enscript-type">unsigned</span> <span class="enscript-type">char</span>*) display_block, g);
	next_number = number + 1;
    }

<span class="enscript-reference">xit</span>:
    <span class="enscript-keyword">if</span> (name) {
	close_media(m);
	free(name);
    }
    <span class="enscript-keyword">return</span>;
}


<span class="enscript-type">void</span>
<span class="enscript-function-name">do_display_entry</span>(partition_map_header *map)
{
    <span class="enscript-type">long</span> number;

    <span class="enscript-keyword">if</span> (map == NULL) {
	bad_input(<span class="enscript-string">&quot;No partition map exists&quot;</span>);
	<span class="enscript-keyword">return</span>;
    }
    <span class="enscript-keyword">if</span> (get_number_argument(<span class="enscript-string">&quot;Partition number: &quot;</span>, &amp;number, kDefault) == 0) {
	bad_input(<span class="enscript-string">&quot;Bad partition number&quot;</span>);
	<span class="enscript-keyword">return</span>;
    }
    <span class="enscript-keyword">if</span> (number == 0) {
    	full_dump_block_zero(map);
    } <span class="enscript-keyword">else</span> {
	full_dump_partition_entry(map, number);
    }
}


<span class="enscript-type">void</span>
<span class="enscript-function-name">do_examine_patch_partition</span>(partition_map_header *map)
{
    partition_map * entry;

    <span class="enscript-keyword">if</span> (map == NULL) {
	bad_input(<span class="enscript-string">&quot;No partition map exists&quot;</span>);
	<span class="enscript-keyword">return</span>;
    }
    entry = find_entry_by_type(kPatchType, map);
    <span class="enscript-keyword">if</span> (entry == NULL) {
	printf(<span class="enscript-string">&quot;No patch partition\n&quot;</span>);
    } <span class="enscript-keyword">else</span> {
	display_patches(entry);
    }
}
</pre>
<hr />
</body></html>