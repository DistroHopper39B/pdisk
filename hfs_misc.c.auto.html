<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>hfs_misc.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">hfs_misc.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="hfs_misc.c">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">//
</span><span class="enscript-comment">// hfs_misc.c - hfs routines
</span><span class="enscript-comment">//
</span><span class="enscript-comment">// Written by Eryk Vershen
</span><span class="enscript-comment">//
</span>
<span class="enscript-comment">/*
 * Copyright 2000 by Eryk Vershen
 */</span>

<span class="enscript-comment">// for *printf()
</span>#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdio.h&gt;</span>

<span class="enscript-comment">// for malloc(), calloc() &amp; free()
</span>#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">__linux__</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdlib.h&gt;</span>
#<span class="enscript-reference">else</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;malloc.h&gt;</span>
#<span class="enscript-reference">endif</span>

<span class="enscript-comment">// for strncpy() &amp; strcmp()
</span>#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>
<span class="enscript-comment">// for O_RDONLY &amp; O_RDWR
</span>#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;fcntl.h&gt;</span>
<span class="enscript-comment">// for errno
</span>#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;errno.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;hfs_misc.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;partition_map.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;convert.h&quot;</span>
#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;errors.h&quot;</span>


<span class="enscript-comment">//
</span><span class="enscript-comment">// Defines
</span><span class="enscript-comment">//
</span>#<span class="enscript-reference">define</span> <span class="enscript-variable-name">MDB_OFFSET</span>	2
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">HFS_SIG</span>		0x4244	<span class="enscript-comment">/* i.e 'BD' */</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">HFS_PLUS_SIG</span>	0x482B	<span class="enscript-comment">/* i.e 'H+' */</span>

#<span class="enscript-reference">define</span> <span class="enscript-function-name">get_align_long</span>(x)	(*(u32*)(x))


<span class="enscript-comment">//
</span><span class="enscript-comment">// Types
</span><span class="enscript-comment">//
</span><span class="enscript-type">typedef</span> <span class="enscript-type">long</span> <span class="enscript-type">long</span> u64;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> ExtDescriptor {		<span class="enscript-comment">// extent descriptor
</span>    u16	xdrStABN;	<span class="enscript-comment">// first allocation block
</span>    u16	xdrNumABlks;	<span class="enscript-comment">// number of allocation blocks
</span>} ext_descriptor;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> ExtDataRec {
    ext_descriptor	ed[3];	<span class="enscript-comment">// extent data record
</span>} ext_data_rec;

<span class="enscript-comment">/*
 * The crazy &quot;u16 x[2]&quot; stuff here is to get around the fact
 * that I can't convince the Mac compiler to align on 32 bit
 * quantities on 16 bit boundaries...
 */</span>
<span class="enscript-type">struct</span> mdb_record {		<span class="enscript-comment">// master directory block
</span>    u16	drSigWord;	<span class="enscript-comment">// volume signature
</span>    u16	drCrDate[2];	<span class="enscript-comment">// date and time of volume creation
</span>    u16	drLsMod[2];	<span class="enscript-comment">// date and time of last modification
</span>    u16	drAtrb;		<span class="enscript-comment">// volume attributes
</span>    u16	drNmFls;	<span class="enscript-comment">// number of files in root directory
</span>    u16	drVBMSt;	<span class="enscript-comment">// first block of volume bitmap
</span>    u16	drAllocPtr;	<span class="enscript-comment">// start of next allocation search
</span>    u16	drNmAlBlks;	<span class="enscript-comment">// number of allocation blocks in volume
</span>    u32	drAlBlkSiz;	<span class="enscript-comment">// size (in bytes) of allocation blocks
</span>    u32	drClpSiz;	<span class="enscript-comment">// default clump size
</span>    u16	drAlBlSt;	<span class="enscript-comment">// first allocation block in volume
</span>    u16	drNxtCNID[2];	<span class="enscript-comment">// next unused catalog node ID
</span>    u16	drFreeBks;	<span class="enscript-comment">// number of unused allocation blocks
</span>    <span class="enscript-type">char</span>	drVN[28];	<span class="enscript-comment">// volume name
</span>    u16	drVolBkUp[2];	<span class="enscript-comment">// date and time of last backup
</span>    u16	drVSeqNum;	<span class="enscript-comment">// volume backup sequence number
</span>    u16	drWrCnt[2];	<span class="enscript-comment">// volume write count
</span>    u16	drXTClpSiz[2];	<span class="enscript-comment">// clump size for extents overflow file
</span>    u16	drCTClpSiz[2];	<span class="enscript-comment">// clump size for catalog file
</span>    u16	drNmRtDirs;	<span class="enscript-comment">// number of directories in root directory
</span>    u32	drFilCnt;	<span class="enscript-comment">// number of files in volume
</span>    u32	drDirCnt;	<span class="enscript-comment">// number of directories in volume
</span>    u32	drFndrInfo[8];	<span class="enscript-comment">// information used by the Finder
</span>#<span class="enscript-reference">ifdef</span> <span class="enscript-variable-name">notdef</span>
    u16	drVCSize;	<span class="enscript-comment">// size (in blocks) of volume cache
</span>    u16	drVBMCSize;	<span class="enscript-comment">// size (in blocks) of volume bitmap cache
</span>    u16	drCtlCSize;	<span class="enscript-comment">// size (in blocks) of common volume cache
</span>#<span class="enscript-reference">else</span>
    u16	drEmbedSigWord;	<span class="enscript-comment">// type of embedded volume
</span>    ext_descriptor	drEmbedExtent;	<span class="enscript-comment">// embedded volume extent
</span>#<span class="enscript-reference">endif</span>
    u16	drXTFlSize[2];	<span class="enscript-comment">// size of extents overflow file
</span>    ext_data_rec	drXTExtRec;	<span class="enscript-comment">// extent record for extents overflow file
</span>    u16	drCTFlSize[2];	<span class="enscript-comment">// size of catalog file
</span>    ext_data_rec	drCTExtRec;	<span class="enscript-comment">// extent record for catalog file
</span>};


<span class="enscript-type">typedef</span> u32 HFSCatalogNodeID;

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> HFSPlusExtentDescriptor {
    u32 startBlock;
    u32 blockCount;
} HFSPlusExtentDescriptor;

<span class="enscript-type">typedef</span> HFSPlusExtentDescriptor HFSPlusExtentRecord[ 8];

<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> HFSPlusForkData {
    u64 logicalSize;
    u32 clumpSize;
    u32 totalBlocks;
    HFSPlusExtentRecord extents;
} HFSPlusForkData;

<span class="enscript-type">struct</span> HFSPlusVolumeHeader {
    u16 signature;
    u16 version;
    u32 attributes;
    u32 lastMountedVersion;
    u32 reserved;
    u32 createDate;
    u32 modifyDate;
    u32 backupDate;
    u32 checkedDate;
    u32 fileCount;
    u32 folderCount;
    u32 blockSize;
    u32 totalBlocks;
    u32 freeBlocks;
    u32 nextAllocation;
    u32 rsrcClumpSize;
    u32 dataClumpSize;
    HFSCatalogNodeID nextCatalogID;
    u32 writeCount;
    u64 encodingsBitmap;
    u8 finderInfo[ 32];
    HFSPlusForkData allocationFile;
    HFSPlusForkData extentsFile;
    HFSPlusForkData catalogFile;
    HFSPlusForkData attributesFile;
    HFSPlusForkData startupFile;
} HFSPlusVolumeHeader;


<span class="enscript-comment">//
</span><span class="enscript-comment">// Global Constants
</span><span class="enscript-comment">//
</span>

<span class="enscript-comment">//
</span><span class="enscript-comment">// Global Variables
</span><span class="enscript-comment">//
</span>

<span class="enscript-comment">//
</span><span class="enscript-comment">// Forward declarations
</span><span class="enscript-comment">//
</span>u32 <span class="enscript-function-name">embeded_offset</span>(<span class="enscript-type">struct</span> mdb_record *mdb, u32 sector);
<span class="enscript-type">int</span> <span class="enscript-function-name">read_partition_block</span>(partition_map *entry, <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> num, <span class="enscript-type">char</span> *buf);


<span class="enscript-comment">//
</span><span class="enscript-comment">// Routines
</span><span class="enscript-comment">//
</span>u32
<span class="enscript-function-name">embeded_offset</span>(<span class="enscript-type">struct</span> mdb_record *mdb, u32 sector)
{
    u32 e_offset;
    
    e_offset = mdb-&gt;drAlBlSt + mdb-&gt;drEmbedExtent.xdrStABN * (mdb-&gt;drAlBlkSiz / 512);
    
    <span class="enscript-keyword">return</span> e_offset + sector;
}


<span class="enscript-type">char</span> *
<span class="enscript-function-name">get_HFS_name</span>(partition_map *entry, <span class="enscript-type">int</span> *kind)
{
    DPME *data;
    <span class="enscript-type">struct</span> mdb_record *mdb;
    <span class="enscript-comment">//struct HFSPlusVolumeHeader *mdb2;
</span>    <span class="enscript-type">char</span> *name = NULL;
    <span class="enscript-type">int</span> len;
    
    *kind = kHFS_not;

    mdb = (<span class="enscript-type">struct</span> mdb_record *) malloc(PBLOCK_SIZE);
    <span class="enscript-keyword">if</span> (mdb == NULL) {
	error(errno, <span class="enscript-string">&quot;can't allocate memory for MDB&quot;</span>);
	<span class="enscript-keyword">return</span> NULL;
    }

    data = entry-&gt;data;
    <span class="enscript-keyword">if</span> (strcmp(data-&gt;dpme_type, kHFSType) == 0) {
	<span class="enscript-keyword">if</span> (read_partition_block(entry, 2, (<span class="enscript-type">char</span> *)mdb) == 0) {
	    error(-1, <span class="enscript-string">&quot;Can't read block %d from partition %d&quot;</span>, 2, entry-&gt;disk_address);
	    <span class="enscript-keyword">goto</span> <span class="enscript-reference">not_hfs</span>;
	}
	<span class="enscript-keyword">if</span> (mdb-&gt;drSigWord == HFS_PLUS_SIG) {
	    <span class="enscript-comment">// pure HFS Plus
</span>	    <span class="enscript-comment">// printf(&quot;%lu HFS Plus\n&quot;, entry-&gt;disk_address);
</span>	    *kind = kHFS_plus;
	} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (mdb-&gt;drSigWord != HFS_SIG) {
	    <span class="enscript-comment">// not HFS !!!
</span>	    <span class="enscript-comment">// printf(&quot;%lu not HFS\n&quot;, entry-&gt;disk_address);
</span>	    *kind = kHFS_not;
	} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (mdb-&gt;drEmbedSigWord != HFS_PLUS_SIG) {
	    <span class="enscript-comment">// HFS
</span>	    <span class="enscript-comment">// printf(&quot;%lu HFS\n&quot;, entry-&gt;disk_address);
</span>	    *kind = kHFS_std;
	    len = mdb-&gt;drVN[0];
	    name = (<span class="enscript-type">char</span> *) malloc(len+1);
	    strncpy(name, &amp;mdb-&gt;drVN[1], len);
	    name[len] = 0;
	} <span class="enscript-keyword">else</span> {
	    <span class="enscript-comment">// embedded HFS plus
</span>	    <span class="enscript-comment">// printf(&quot;%lu embedded HFS Plus\n&quot;, entry-&gt;disk_address);
</span>	    *kind = kHFS_embed;
	    len = mdb-&gt;drVN[0];
	    name = (<span class="enscript-type">char</span> *) malloc(len+1);
	    strncpy(name, &amp;mdb-&gt;drVN[1], len);
	    name[len] = 0;
	}
    }
<span class="enscript-reference">not_hfs</span>:
    free(mdb);
    <span class="enscript-keyword">return</span> name;
}

<span class="enscript-comment">// really need a function to read block n from partition m
</span>
<span class="enscript-type">int</span>
<span class="enscript-function-name">read_partition_block</span>(partition_map *entry, <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> num, <span class="enscript-type">char</span> *buf)
{
    DPME *data;
    partition_map_header * map;
    u32 base;
    u64 offset;
    
    map = entry-&gt;the_map;
    data = entry-&gt;data;
    base = data-&gt;dpme_pblock_start;

    <span class="enscript-keyword">if</span> (num &gt;= data-&gt;dpme_pblocks) {
	<span class="enscript-keyword">return</span> 0;
    }
    offset = ((<span class="enscript-type">long</span> <span class="enscript-type">long</span>) base) * map-&gt;logical_block + num * 512;
    
    <span class="enscript-keyword">return</span> read_media(map-&gt;m, offset, 512, (<span class="enscript-type">void</span> *)buf);
}
</pre>
<hr />
</body></html>