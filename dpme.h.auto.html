<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>dpme.h</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">dpme.h&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="dpme.h">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">//
</span><span class="enscript-comment">// dpme.h - Disk Partition Map Entry (dpme)
</span><span class="enscript-comment">//
</span><span class="enscript-comment">// Written by Eryk Vershen
</span><span class="enscript-comment">//
</span><span class="enscript-comment">// This file describes structures and values related to the standard
</span><span class="enscript-comment">// Apple SCSI disk partitioning scheme.
</span><span class="enscript-comment">//
</span><span class="enscript-comment">// Each entry is (and shall remain) 512 bytes long.
</span><span class="enscript-comment">//
</span><span class="enscript-comment">// For more information see:
</span><span class="enscript-comment">//	&quot;Inside Macintosh: Devices&quot; pages 3-12 to 3-15.
</span><span class="enscript-comment">//	&quot;Inside Macintosh - Volume V&quot; pages V-576 to V-582
</span><span class="enscript-comment">//	&quot;Inside Macintosh - Volume IV&quot; page IV-292
</span><span class="enscript-comment">//
</span><span class="enscript-comment">// There is a kernel file with much of the same info (under different names):
</span><span class="enscript-comment">//	/usr/src/mklinux-1.0DR2/osfmk/src/mach_kernel/ppc/POWERMAC/mac_label.h
</span><span class="enscript-comment">//
</span>
<span class="enscript-comment">/*
 * Copyright 1996 by Apple Computer, Inc.
 *              All Rights Reserved 
 *  
 * Permission to use, copy, modify, and distribute this software and 
 * its documentation for any purpose and without fee is hereby granted, 
 * provided that the above copyright notice appears in all copies and 
 * that both the copyright notice and this permission notice appear in 
 * supporting documentation. 
 *  
 * APPLE COMPUTER DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE 
 * INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS 
 * FOR A PARTICULAR PURPOSE. 
 *  
 * IN NO EVENT SHALL APPLE COMPUTER BE LIABLE FOR ANY SPECIAL, INDIRECT, OR 
 * CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM 
 * LOSS OF USE, DATA OR PROFITS, WHETHER IN ACTION OF CONTRACT, 
 * NEGLIGENCE, OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION 
 * WITH THE USE OR PERFORMANCE OF THIS SOFTWARE. 
 */</span>
#<span class="enscript-reference">ifndef</span> <span class="enscript-variable-name">__dpme__</span>
#<span class="enscript-reference">define</span> <span class="enscript-variable-name">__dpme__</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;bitfield.h&quot;</span>

<span class="enscript-comment">//
</span><span class="enscript-comment">// Defines
</span><span class="enscript-comment">//
</span>#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BLOCK0_SIGNATURE</span>	0x4552	<span class="enscript-comment">/* i.e. 'ER' */</span>

#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DPISTRLEN</span>	32
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">DPME_SIGNATURE</span>	0x504D		<span class="enscript-comment">/* i.e. 'PM' */</span>

<span class="enscript-comment">// A/UX only stuff (tradition!)
</span>#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">dpme_bzb</span>	dpme_boot_args
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">BZBMAGIC</span> 0xABADBABE	<span class="enscript-comment">/* BZB magic number */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">FST</span>	((u8) 0x1)	<span class="enscript-comment">/* standard UNIX FS */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">FSTEFS</span>	((u8) 0x2)	<span class="enscript-comment">/* Autorecovery FS */</span>
#<span class="enscript-reference">define</span>	<span class="enscript-variable-name">FSTSFS</span>	((u8) 0x3)	<span class="enscript-comment">/* Swap FS */</span>


<span class="enscript-comment">//
</span><span class="enscript-comment">// Types
</span><span class="enscript-comment">//
</span><span class="enscript-type">typedef</span>	<span class="enscript-type">unsigned</span> <span class="enscript-type">char</span>	u8;
<span class="enscript-type">typedef</span>	<span class="enscript-type">unsigned</span> <span class="enscript-type">short</span>	u16;
<span class="enscript-type">typedef</span>	<span class="enscript-type">unsigned</span> <span class="enscript-type">int</span>	u32;


<span class="enscript-comment">// Physical block zero of the disk has this format
</span><span class="enscript-type">struct</span> Block0 {
    u16 	sbSig;		<span class="enscript-comment">/* unique value for SCSI block 0 */</span>
    u16 	sbBlkSize;	<span class="enscript-comment">/* block size of device */</span>
    u32 	sbBlkCount;	<span class="enscript-comment">/* number of blocks on device */</span>
    u16 	sbDevType;	<span class="enscript-comment">/* device type */</span>
    u16 	sbDevId;	<span class="enscript-comment">/* device id */</span>
    u32 	sbData;		<span class="enscript-comment">/* not used */</span>
    u16 	sbDrvrCount;	<span class="enscript-comment">/* driver descriptor count */</span>
    u16 	sbMap[247];	<span class="enscript-comment">/* descriptor map */</span>
};
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> Block0 Block0;

<span class="enscript-comment">// Where &amp;sbMap[0] is actually an array DDMap[sbDrvrCount]
</span><span class="enscript-comment">// kludge to get around alignment junk
</span><span class="enscript-type">struct</span> DDMap {
    u32 	ddBlock;	<span class="enscript-comment">/* 1st driver's starting block (in sbBlkSize blocks!) */</span>
    u16 	ddSize;		<span class="enscript-comment">/* size of 1st driver (512-byte blks) */</span>
    u16 	ddType;		<span class="enscript-comment">/* system type (1 for Mac+) */</span>
};
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> DDMap DDMap;


<span class="enscript-comment">// Each partition map entry (blocks 1 through n) has this format
</span><span class="enscript-type">struct</span> dpme {
    u16     dpme_signature          ;
    u16     dpme_reserved_1         ;
    u32     dpme_map_entries        ;
    u32     dpme_pblock_start       ;
    u32     dpme_pblocks            ;
    <span class="enscript-type">char</span>    dpme_name[DPISTRLEN]    ;  <span class="enscript-comment">/* name of partition */</span>
    <span class="enscript-type">char</span>    dpme_type[DPISTRLEN]    ;  <span class="enscript-comment">/* type of partition */</span>
    u32     dpme_lblock_start       ;
    u32     dpme_lblocks            ;
    u32     dpme_flags;
#<span class="enscript-reference">if</span> 0
    u32     dpme_reserved_2    : 23 ;  <span class="enscript-comment">/* Bit 9 through 31.        */</span>
    u32     dpme_os_specific_1 :  1 ;  <span class="enscript-comment">/* Bit 8.                   */</span>
    u32     dpme_os_specific_2 :  1 ;  <span class="enscript-comment">/* Bit 7.                   */</span>
    u32     dpme_os_pic_code   :  1 ;  <span class="enscript-comment">/* Bit 6.                   */</span>
    u32     dpme_writable      :  1 ;  <span class="enscript-comment">/* Bit 5.                   */</span>
    u32     dpme_readable      :  1 ;  <span class="enscript-comment">/* Bit 4.                   */</span>
    u32     dpme_bootable      :  1 ;  <span class="enscript-comment">/* Bit 3.                   */</span>
    u32     dpme_in_use        :  1 ;  <span class="enscript-comment">/* Bit 2.                   */</span>
    u32     dpme_allocated     :  1 ;  <span class="enscript-comment">/* Bit 1.                   */</span>
    u32     dpme_valid         :  1 ;  <span class="enscript-comment">/* Bit 0.                   */</span>
#<span class="enscript-reference">endif</span>
    u32     dpme_boot_block         ;
    u32     dpme_boot_bytes         ;
    u32     dpme_load_addr          ;
    u32     dpme_load_addr_2        ;
    u32     dpme_goto_addr          ;
    u32     dpme_goto_addr_2        ;
    u32     dpme_checksum           ;
    <span class="enscript-type">char</span>    dpme_process_id[16]     ;
    u32     dpme_boot_args[32]      ;
    u32     dpme_reserved_3[62]     ;
};
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> dpme DPME;

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">dpme_diskdriver_set</span>(p, v)	bitfield_set(&amp;p-&gt;dpme_flags, 9, 1, v)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">dpme_chainable_set</span>(p, v)	bitfield_set(&amp;p-&gt;dpme_flags, 8, 1, v)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">dpme_os_specific_1_set</span>(p, v)	bitfield_set(&amp;p-&gt;dpme_flags, 8, 1, v)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">dpme_os_specific_2_set</span>(p, v)	bitfield_set(&amp;p-&gt;dpme_flags, 7, 1, v)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">dpme_os_pic_code_set</span>(p, v)	bitfield_set(&amp;p-&gt;dpme_flags, 6, 1, v)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">dpme_writable_set</span>(p, v)		bitfield_set(&amp;p-&gt;dpme_flags, 5, 1, v)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">dpme_readable_set</span>(p, v)		bitfield_set(&amp;p-&gt;dpme_flags, 4, 1, v)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">dpme_bootable_set</span>(p, v)		bitfield_set(&amp;p-&gt;dpme_flags, 3, 1, v)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">dpme_in_use_set</span>(p, v)		bitfield_set(&amp;p-&gt;dpme_flags, 2, 1, v)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">dpme_allocated_set</span>(p, v)	bitfield_set(&amp;p-&gt;dpme_flags, 1, 1, v)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">dpme_valid_set</span>(p, v)		bitfield_set(&amp;p-&gt;dpme_flags, 0, 1, v)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">dpme_diskdriver_get</span>(p)		bitfield_get(p-&gt;dpme_flags, 9, 1)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">dpme_chainable_get</span>(p)		bitfield_get(p-&gt;dpme_flags, 8, 1)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">dpme_os_specific_1_get</span>(p)	bitfield_get(p-&gt;dpme_flags, 8, 1)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">dpme_os_specific_2_get</span>(p)	bitfield_get(p-&gt;dpme_flags, 7, 1)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">dpme_os_pic_code_get</span>(p)		bitfield_get(p-&gt;dpme_flags, 6, 1)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">dpme_writable_get</span>(p)		bitfield_get(p-&gt;dpme_flags, 5, 1)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">dpme_readable_get</span>(p)		bitfield_get(p-&gt;dpme_flags, 4, 1)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">dpme_bootable_get</span>(p)		bitfield_get(p-&gt;dpme_flags, 3, 1)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">dpme_in_use_get</span>(p)		bitfield_get(p-&gt;dpme_flags, 2, 1)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">dpme_allocated_get</span>(p)		bitfield_get(p-&gt;dpme_flags, 1, 1)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">dpme_valid_get</span>(p)		bitfield_get(p-&gt;dpme_flags, 0, 1)


<span class="enscript-comment">// A/UX only data structures (sentimental reasons?)
</span>
<span class="enscript-comment">// Alternate block map (aka bad block remaping) [Never really used]
</span><span class="enscript-type">struct</span> abm		<span class="enscript-comment">/* altblk map info stored in bzb */</span>
{
    u32  abm_size;	<span class="enscript-comment">/* size of map in bytes */</span>
    u32  abm_ents;	<span class="enscript-comment">/* number of used entries */</span>
    u32  abm_start;	<span class="enscript-comment">/* start of altblk map */</span>
};
<span class="enscript-type">typedef</span>	<span class="enscript-type">struct</span> abm ABM;

<span class="enscript-comment">// BZB (Block Zero Block, but I can't remember the etymology)
</span><span class="enscript-comment">// Where &amp;dpme_boot_args[0] is actually the address of a struct bzb
</span><span class="enscript-comment">// kludge to get around alignment junk
</span><span class="enscript-type">struct</span>	bzb			<span class="enscript-comment">/* block zero block format */</span>
{
    u32  bzb_magic;		<span class="enscript-comment">/* magic number */</span>
    u8   bzb_cluster;		<span class="enscript-comment">/* Autorecovery cluster grouping */</span>
    u8   bzb_type;		<span class="enscript-comment">/* FS type */</span>
    u16  bzb_inode;		<span class="enscript-comment">/* bad block inode number */</span>
    u32  bzb_flags;
#<span class="enscript-reference">if</span> 0
    u16  bzb_root:1,		<span class="enscript-comment">/* FS is a root FS */</span>
	 <span class="enscript-reference">bzb_usr</span>:1,		<span class="enscript-comment">/* FS is a usr FS */</span>
	 <span class="enscript-reference">bzb_crit</span>:1,		<span class="enscript-comment">/* FS is a critical FS */</span>
	 <span class="enscript-reference">bzb_rsrvd</span>:8,		<span class="enscript-comment">/* reserved for later use */</span>
	 <span class="enscript-reference">bzb_slice</span>:5;		<span class="enscript-comment">/* slice number to associate with plus one */</span>
    u16  bzb_filler;		<span class="enscript-comment">/* pad bitfield to 32 bits */</span>
#<span class="enscript-reference">endif</span>
    u32  bzb_tmade;		<span class="enscript-comment">/* time of FS creation */</span>
    u32  bzb_tmount;		<span class="enscript-comment">/* time of last mount */</span>
    u32  bzb_tumount;		<span class="enscript-comment">/* time of last umount */</span>
    ABM  bzb_abm;		<span class="enscript-comment">/* altblk map info */</span>
    u32  bzb_fill2[7];		<span class="enscript-comment">/* for expansion of ABM (ha!ha!) */</span>
    u8   bzb_mount_point[64];	<span class="enscript-comment">/* default mount point name */</span>
};
<span class="enscript-type">typedef</span>	<span class="enscript-type">struct</span> bzb	BZB;

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">bzb_root_set</span>(p, v)		bitfield_set(&amp;p-&gt;bzb_flags, 31, 1, v)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">bzb_usr_set</span>(p, v)		bitfield_set(&amp;p-&gt;bzb_flags, 30, 1, v)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">bzb_crit_set</span>(p, v)		bitfield_set(&amp;p-&gt;bzb_flags, 29, 1, v)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">bzb_slice_set</span>(p, v)		bitfield_set(&amp;p-&gt;bzb_flags, 20, 5, v)

#<span class="enscript-reference">define</span>	<span class="enscript-function-name">bzb_root_get</span>(p)			bitfield_get(p-&gt;bzb_flags, 31, 1)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">bzb_usr_get</span>(p)			bitfield_get(p-&gt;bzb_flags, 30, 1)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">bzb_crit_get</span>(p)			bitfield_get(p-&gt;bzb_flags, 29, 1)
#<span class="enscript-reference">define</span>	<span class="enscript-function-name">bzb_slice_get</span>(p)		bitfield_get(p-&gt;bzb_flags, 20, 5)


<span class="enscript-comment">//
</span><span class="enscript-comment">// Global Constants
</span><span class="enscript-comment">//
</span>

<span class="enscript-comment">//
</span><span class="enscript-comment">// Global Variables
</span><span class="enscript-comment">//
</span>

<span class="enscript-comment">//
</span><span class="enscript-comment">// Forward declarations
</span><span class="enscript-comment">//
</span>
#<span class="enscript-reference">endif</span> <span class="enscript-comment">/* __dpme__ */</span>
</pre>
<hr />
</body></html>