<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>deblock_media.c</title>
<style type="text/css">
.enscript-comment { font-style: italic; color: rgb(178,34,34); }
.enscript-function-name { font-weight: bold; color: rgb(0,0,255); }
.enscript-variable-name { font-weight: bold; color: rgb(184,134,11); }
.enscript-keyword { font-weight: bold; color: rgb(160,32,240); }
.enscript-reference { font-weight: bold; color: rgb(95,158,160); }
.enscript-string { font-weight: bold; color: rgb(188,143,143); }
.enscript-builtin { font-weight: bold; color: rgb(218,112,214); }
.enscript-type { font-weight: bold; color: rgb(34,139,34); }
.enscript-highlight { text-decoration: underline; color: 0; }
</style>
</head>
<body id="top">
<h1 style="margin:8px;" id="f1">deblock_media.c&nbsp;&nbsp;&nbsp;<span style="font-weight: normal; font-size: 0.5em;">[<a href="deblock_media.c">plain text</a>]</span></h1>
<hr/>
<div></div>
<pre>
<span class="enscript-comment">/*
 * deblock_media.c -
 *
 * Written by Eryk Vershen
 */</span>

<span class="enscript-comment">/*
 * Copyright 1997,1998 by Apple Computer, Inc.
 *              All Rights Reserved 
 *  
 * Permission to use, copy, modify, and distribute this software and 
 * its documentation for any purpose and without fee is hereby granted, 
 * provided that the above copyright notice appears in all copies and 
 * that both the copyright notice and this permission notice appear in 
 * supporting documentation. 
 *  
 * APPLE COMPUTER DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE 
 * INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS 
 * FOR A PARTICULAR PURPOSE. 
 *  
 * IN NO EVENT SHALL APPLE COMPUTER BE LIABLE FOR ANY SPECIAL, INDIRECT, OR 
 * CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM 
 * LOSS OF USE, DATA OR PROFITS, WHETHER IN ACTION OF CONTRACT, 
 * NEGLIGENCE, OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION 
 * WITH THE USE OR PERFORMANCE OF THIS SOFTWARE. 
 */</span>


<span class="enscript-comment">// for malloc() &amp; free()
</span>#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;stdlib.h&gt;</span>
<span class="enscript-comment">// for memcpy()
</span>#<span class="enscript-reference">include</span> <span class="enscript-string">&lt;string.h&gt;</span>

#<span class="enscript-reference">include</span> <span class="enscript-string">&quot;deblock_media.h&quot;</span>


<span class="enscript-comment">/*
 * Defines
 */</span>


<span class="enscript-comment">/*
 * Types
 */</span>
<span class="enscript-type">typedef</span> <span class="enscript-type">struct</span> deblock_media *DEBLOCK_MEDIA;

<span class="enscript-type">struct</span> deblock_media {
    <span class="enscript-type">struct</span> media    m;
    <span class="enscript-type">long</span>            need_filtering;
    MEDIA           next_media;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span>   next_block_size;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span>   *buffer;
};

<span class="enscript-type">struct</span> deblock_globals {
    <span class="enscript-type">long</span>        exists;
    <span class="enscript-type">long</span>        kind;
};


<span class="enscript-comment">/*
 * Global Constants
 */</span>


<span class="enscript-comment">/*
 * Global Variables
 */</span>
<span class="enscript-type">static</span> <span class="enscript-type">long</span> deblock_inited = 0;
<span class="enscript-type">static</span> <span class="enscript-type">struct</span> deblock_globals deblock_info;

<span class="enscript-comment">/*
 * Forward declarations
 */</span>
<span class="enscript-type">void</span> <span class="enscript-function-name">deblock_init</span>(<span class="enscript-type">void</span>);
DEBLOCK_MEDIA <span class="enscript-function-name">new_deblock_media</span>(<span class="enscript-type">void</span>);
<span class="enscript-type">long</span> <span class="enscript-function-name">read_deblock_media</span>(MEDIA m, <span class="enscript-type">long</span> <span class="enscript-type">long</span> offset, <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> count, <span class="enscript-type">void</span> *address);
<span class="enscript-type">long</span> <span class="enscript-function-name">write_deblock_media</span>(MEDIA m, <span class="enscript-type">long</span> <span class="enscript-type">long</span> offset, <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> count, <span class="enscript-type">void</span> *address);
<span class="enscript-type">long</span> <span class="enscript-function-name">close_deblock_media</span>(MEDIA m);
<span class="enscript-type">long</span> <span class="enscript-function-name">os_reload_deblock_media</span>(MEDIA m);


<span class="enscript-comment">/*
 * Routines
 */</span>
<span class="enscript-type">void</span>
<span class="enscript-function-name">deblock_init</span>(<span class="enscript-type">void</span>)
{
    <span class="enscript-keyword">if</span> (deblock_inited != 0) {
	<span class="enscript-keyword">return</span>;
    }
    deblock_inited = 1;
    
    deblock_info.kind = allocate_media_kind();
}


DEBLOCK_MEDIA
<span class="enscript-function-name">new_deblock_media</span>(<span class="enscript-type">void</span>)
{
    <span class="enscript-keyword">return</span> (DEBLOCK_MEDIA) new_media(<span class="enscript-keyword">sizeof</span>(<span class="enscript-type">struct</span> deblock_media));
}


MEDIA
<span class="enscript-function-name">open_deblock_media</span>(<span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> new_block_size, MEDIA m)
{
    DEBLOCK_MEDIA   a;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span>   block_size;
    
    <span class="enscript-keyword">if</span> (deblock_inited == 0) {
	deblock_init();
    }
    
    a = 0;
    <span class="enscript-keyword">if</span> (m != 0) {
	block_size = media_granularity(m);

	<span class="enscript-keyword">if</span> (new_block_size == block_size) {
	    <span class="enscript-keyword">return</span> m;

	} <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (new_block_size &gt; block_size) {
	    <span class="enscript-keyword">if</span> ((new_block_size % block_size) == 0) {
		<span class="enscript-comment">/* no filtering necessary */</span>
		a = new_deblock_media();
		<span class="enscript-keyword">if</span> (a != 0) {
		    a-&gt;need_filtering = 0;
		    a-&gt;next_block_size = block_size;
		    a-&gt;buffer = 0;
		}
	    } <span class="enscript-keyword">else</span> {
		<span class="enscript-comment">/* too hard to bother with */</span>
	    }
	} <span class="enscript-keyword">else</span> <span class="enscript-comment">/* new_block_size &lt; block_size */</span> {
	    <span class="enscript-keyword">if</span> ((block_size % new_block_size) == 0) {
		<span class="enscript-comment">/* block &amp; unblock */</span>
		a = new_deblock_media();
		<span class="enscript-keyword">if</span> (a != 0) {
		    a-&gt;need_filtering = 1;
		    a-&gt;next_block_size = block_size;
		    a-&gt;buffer = malloc(block_size);
		}
	    } <span class="enscript-keyword">else</span> {
		<span class="enscript-comment">/* too hard to bother with */</span>
	    }
	}
	<span class="enscript-keyword">if</span> (a != 0) {
	    a-&gt;m.kind = deblock_info.kind;
	    a-&gt;m.grain = new_block_size;
	    a-&gt;m.size_in_bytes = media_total_size(m);
	    a-&gt;m.do_read = read_deblock_media;
	    a-&gt;m.do_write = write_deblock_media;
	    a-&gt;m.do_close = close_deblock_media;
	    a-&gt;m.do_os_reload = os_reload_deblock_media;
	    a-&gt;next_media = m;
	}
    }
    <span class="enscript-keyword">return</span> (MEDIA) a;
}


<span class="enscript-type">long</span>
<span class="enscript-function-name">read_deblock_media</span>(MEDIA m, <span class="enscript-type">long</span> <span class="enscript-type">long</span> offset, <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> count, <span class="enscript-type">void</span> *address)
{
    DEBLOCK_MEDIA a;
    <span class="enscript-type">long</span> rtn_value;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> next_size;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> partial_offset;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> partial_count;
    <span class="enscript-type">long</span> <span class="enscript-type">long</span> cur_offset;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> remainder;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *addr;

    a = (DEBLOCK_MEDIA) m;
    rtn_value = 0;
    <span class="enscript-keyword">if</span> (a == 0) {
	<span class="enscript-comment">/* no media */</span>
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (a-&gt;m.kind != deblock_info.kind) {
	<span class="enscript-comment">/* wrong kind - XXX need to error here - this is an internal problem */</span>
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (count &lt;= 0 || count % a-&gt;m.grain != 0) {
	<span class="enscript-comment">/* can't handle size */</span>
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (offset &lt; 0 || offset % a-&gt;m.grain != 0) {
	<span class="enscript-comment">/* can't handle offset */</span>
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (a-&gt;need_filtering == 0) {
	rtn_value = read_media(a-&gt;next_media, offset, count, address);
    } <span class="enscript-keyword">else</span> {
	next_size = a-&gt;next_block_size;
	addr = address;
	cur_offset = offset;
	remainder = count;
	rtn_value = 1;

	<span class="enscript-comment">/* read partial */</span>
	partial_offset = cur_offset % next_size;
	<span class="enscript-keyword">if</span> (partial_offset != 0) {
	    partial_count = next_size - partial_offset;
	    <span class="enscript-keyword">if</span> (partial_count &gt; remainder) {
		partial_count = remainder;
	    }
	    rtn_value = read_media(a-&gt;next_media, cur_offset - partial_offset, next_size, a-&gt;buffer);
	    <span class="enscript-keyword">if</span> (rtn_value != 0) {
		memcpy (addr, a-&gt;buffer + partial_offset, partial_count);
		addr += partial_count;
		cur_offset += partial_count;
		remainder -= partial_count;
	    }
	}
	<span class="enscript-comment">/* read fulls as long as needed */</span>
	<span class="enscript-keyword">if</span> (rtn_value != 0 &amp;&amp; remainder &gt; next_size) {
	    partial_count = remainder - (remainder % next_size);
	    rtn_value = read_media(a-&gt;next_media, cur_offset, partial_count, addr);
	    addr += partial_count;
	    cur_offset += partial_count;
	    remainder -= partial_count;
	}
	<span class="enscript-comment">/* read partial */</span>
	<span class="enscript-keyword">if</span> (rtn_value != 0 &amp;&amp; remainder &gt; 0) {
	    partial_count = remainder;
	    rtn_value = read_media(a-&gt;next_media, cur_offset, next_size, a-&gt;buffer);
	    <span class="enscript-keyword">if</span> (rtn_value != 0) {
		memcpy (addr, a-&gt;buffer, partial_count);
	    }
	}
    }
    <span class="enscript-keyword">return</span> rtn_value;
}


<span class="enscript-type">long</span>
<span class="enscript-function-name">write_deblock_media</span>(MEDIA m, <span class="enscript-type">long</span> <span class="enscript-type">long</span> offset, <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> count, <span class="enscript-type">void</span> *address)
{
    DEBLOCK_MEDIA a;
    <span class="enscript-type">long</span> rtn_value;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> next_size;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> partial_offset;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> partial_count;
    <span class="enscript-type">long</span> <span class="enscript-type">long</span> cur_offset;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">long</span> remainder;
    <span class="enscript-type">unsigned</span> <span class="enscript-type">char</span> *addr;
    
    a = (DEBLOCK_MEDIA) m;
    rtn_value = 0;
    <span class="enscript-keyword">if</span> (a == 0) {
	<span class="enscript-comment">/* no media */</span>
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (a-&gt;m.kind != deblock_info.kind) {
	<span class="enscript-comment">/* wrong kind - XXX need to error here - this is an internal problem */</span>
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (count &lt;= 0 || count % a-&gt;m.grain != 0) {
	<span class="enscript-comment">/* can't handle size */</span>
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (offset &lt; 0 || offset % a-&gt;m.grain != 0) {
	<span class="enscript-comment">/* can't handle offset */</span>
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (a-&gt;need_filtering == 0) {
	rtn_value = write_media(a-&gt;next_media, offset, count, address);
    } <span class="enscript-keyword">else</span> {
	next_size = a-&gt;next_block_size;
	addr = address;
	cur_offset = offset;
	remainder = count;
	rtn_value = 1;

	<span class="enscript-comment">/* write partial */</span>
	partial_offset = cur_offset % next_size;
	<span class="enscript-keyword">if</span> (partial_offset != 0) {
	    partial_count = next_size - partial_offset;
	    <span class="enscript-keyword">if</span> (partial_count &gt; remainder) {
		partial_count = remainder;
	    }
	    rtn_value = read_media(a-&gt;next_media, cur_offset - partial_offset, next_size, a-&gt;buffer);
	    <span class="enscript-keyword">if</span> (rtn_value != 0) {
		memcpy (a-&gt;buffer + partial_offset, addr, partial_count);
		rtn_value = write_media(a-&gt;next_media, cur_offset - partial_offset, next_size, a-&gt;buffer);
		addr += partial_count;
		cur_offset += partial_count;
		remainder -= partial_count;
	    }
	}
	<span class="enscript-comment">/* write fulls as long as needed */</span>
	<span class="enscript-keyword">if</span> (rtn_value != 0 &amp;&amp; remainder &gt; next_size) {
	    partial_count = remainder - (remainder % next_size);
	    rtn_value = write_media(a-&gt;next_media, cur_offset, partial_count, addr);
	    addr += partial_count;
	    cur_offset += partial_count;
	    remainder -= partial_count;
	}
	<span class="enscript-comment">/* write partial */</span>
	<span class="enscript-keyword">if</span> (rtn_value != 0 &amp;&amp; remainder &gt; 0) {
	    partial_count = remainder;
	    rtn_value = read_media(a-&gt;next_media, cur_offset, next_size, a-&gt;buffer);
	    <span class="enscript-keyword">if</span> (rtn_value != 0) {
		memcpy (a-&gt;buffer, addr, partial_count);
		rtn_value = write_media(a-&gt;next_media, cur_offset, next_size, a-&gt;buffer);
	    }
	}
    }
    <span class="enscript-comment">/* recompute size to handle file media */</span>
    a-&gt;m.size_in_bytes = media_total_size(a-&gt;next_media);
    <span class="enscript-keyword">return</span> rtn_value;
}


<span class="enscript-type">long</span>
<span class="enscript-function-name">close_deblock_media</span>(MEDIA m)
{
    DEBLOCK_MEDIA a;
    
    a = (DEBLOCK_MEDIA) m;
    <span class="enscript-keyword">if</span> (a == 0) {
	<span class="enscript-keyword">return</span> 0;
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (a-&gt;m.kind != deblock_info.kind) {
	<span class="enscript-comment">/* XXX need to error here - this is an internal problem */</span>
	<span class="enscript-keyword">return</span> 0;
    }
    
    close_media(a-&gt;next_media);
    free(a-&gt;buffer);
    <span class="enscript-keyword">return</span> 1;
}


<span class="enscript-type">long</span>
<span class="enscript-function-name">os_reload_deblock_media</span>(MEDIA m)
{
    DEBLOCK_MEDIA a;
    
    a = (DEBLOCK_MEDIA) m;
    <span class="enscript-keyword">if</span> (a == 0) {
	<span class="enscript-keyword">return</span> 0;
    } <span class="enscript-keyword">else</span> <span class="enscript-keyword">if</span> (a-&gt;m.kind != deblock_info.kind) {
	<span class="enscript-comment">/* XXX need to error here - this is an internal problem */</span>
	<span class="enscript-keyword">return</span> 0;
    }
    
    os_reload_media(a-&gt;next_media);
    <span class="enscript-keyword">return</span> 1;
}
</pre>
<hr />
</body></html>